<!--pages/chores/chores.wxml - ç²¾ç¾è®¾è®¡ç‰ˆ-->
<view class="chores-page">
  <!-- é¡¶éƒ¨æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tabs-wrapper">
    <view class="tabs-bg"></view>
    <view class="tabs {{isAdmin ? 'tabs-3' : 'tabs-2'}}">
      <view class="tab-item {{activeTab === 'record' ? 'active' : ''}}" 
            data-tab="record" 
            bindtap="switchTab">
        <text class="tab-icon">âœï¸</text>
        <text class="tab-text">è®°å½•å®¶åŠ¡</text>
      </view>
      <view class="tab-item {{activeTab === 'history' ? 'active' : ''}}" 
            data-tab="history" 
            bindtap="switchTab">
        <text class="tab-icon">ğŸ“‹</text>
        <text class="tab-text">å†å²è®°å½•</text>
      </view>
      <!-- å®¡æ ¸å…¥å£ï¼ˆç®¡ç†å‘˜å¯è§ï¼‰ -->
      <view class="tab-item review-tab {{activeTab === 'review' ? 'active' : ''}}" 
            data-tab="review" 
            bindtap="switchTab"
            wx:if="{{isAdmin}}">
        <text class="tab-icon">âœ…</text>
        <text class="tab-text">å¾…å®¡æ ¸</text>
        <view class="badge" wx:if="{{pendingCount > 0}}">{{pendingCount > 99 ? '99+' : pendingCount}}</view>
      </view>
      <view class="tab-indicator {{activeTab === 'history' ? 'pos-2' : (activeTab === 'review' ? 'pos-3' : '')}}"></view>
    </view>
  </view>

  <!-- è®°å½•å®¶åŠ¡ -->
  <view class="tab-content" wx:if="{{activeTab === 'record'}}">
    <!-- æ— å®¶åº­æç¤º -->
    <view class="empty-state" wx:if="{{!familyInfo}}">
      <view class="empty-icon animate-float">ğŸ </view>
      <text class="empty-title">è¯·å…ˆåŠ å…¥å®¶åº­</text>
      <text class="empty-desc">åŠ å…¥æˆ–åˆ›å»ºä¸€ä¸ªå®¶åº­åï¼Œæ‰èƒ½è®°å½•å®¶åŠ¡å“¦</text>
    </view>

    <!-- å®¶åŠ¡ç±»å‹åˆ—è¡¨ -->
    <block wx:elif="{{choreTypes.length > 0}}">
      <!-- åˆ†ç±»æ ‡ç­¾ -->
      <scroll-view class="category-scroll" scroll-x enable-flex>
        <view class="category-item {{currentCategory === 'all' ? 'active' : ''}}" 
              data-category="all" bindtap="switchCategory">
          <text>å…¨éƒ¨</text>
        </view>
        <view class="category-item {{currentCategory === 'clean' ? 'active' : ''}}" 
              data-category="clean" bindtap="switchCategory">
          <text>ğŸ§¹ æ¸…æ´</text>
        </view>
        <view class="category-item {{currentCategory === 'cook' ? 'active' : ''}}" 
              data-category="cook" bindtap="switchCategory">
          <text>ğŸ³ çƒ¹é¥ª</text>
        </view>
        <view class="category-item {{currentCategory === 'laundry' ? 'active' : ''}}" 
              data-category="laundry" bindtap="switchCategory">
          <text>ğŸ‘• æ´—è¡£</text>
        </view>
        <view class="category-item {{currentCategory === 'other' ? 'active' : ''}}" 
              data-category="other" bindtap="switchCategory">
          <text>ğŸ“¦ å…¶ä»–</text>
        </view>
      </scroll-view>

      <!-- å®¶åŠ¡å¡ç‰‡ç½‘æ ¼ -->
      <view class="chore-grid">
        <view class="chore-card {{item.description ? 'has-desc' : ''}}" 
              wx:for="{{choreTypes}}" 
              wx:key="id"
              data-item="{{item}}"
              bindtap="selectChoreType">
          <view class="card-color-bar bar-{{index % 4}}"></view>
          <view class="chore-content">
            <view class="chore-icon-wrap">
              <text class="chore-emoji">{{item.icon || 'ğŸ§¹'}}</text>
            </view>
            <text class="chore-name">{{item.name}}</text>
            <text class="chore-desc" wx:if="{{item.description}}">{{item.description}}</text>
            <view class="chore-points-badge">
              <text class="points-text">+{{item.points}}</text>
              <text class="points-unit">åˆ†</text>
            </view>
          </view>
        </view>
      </view>

      <view class="add-type-btn" bindtap="goToRewards">
        <text class="add-icon">â•</text>
        <text class="add-text">æ·»åŠ æ›´å¤šå®¶åŠ¡ç±»å‹</text>
      </view>
    </block>

    <!-- æ— å®¶åŠ¡ç±»å‹ -->
    <view class="empty-state" wx:else>
      <view class="empty-icon animate-float">ğŸ“</view>
      <text class="empty-title">è¿˜æ²¡æœ‰è®¾ç½®å®¶åŠ¡ç±»å‹</text>
      <text class="empty-desc">å»å¥–åŠ±è®¾ç½®é¡µé¢æ·»åŠ å®¶åŠ¡ç±»å‹å§</text>
      <button class="empty-btn" bindtap="goToRewards">
        <text>å»è®¾ç½®</text>
      </button>
    </view>
  </view>

  <!-- å†å²è®°å½• -->
  <view class="tab-content" wx:if="{{activeTab === 'history'}}">
    <view class="records-list" wx:if="{{choreRecords.length > 0}}">
      <view class="record-card" wx:for="{{choreRecords}}" wx:key="id">
        <view class="record-color-bar bar-{{index % 4}}"></view>
        <view class="record-main">
          <view class="record-header">
            <view class="record-user">
              <image class="record-avatar" src="{{item.user.avatarUrl || '/assets/images/default-avatar.png'}}"></image>
              <text class="record-username">{{item.user.nickname}}</text>
            </view>
            <view class="record-points-tag {{item.status === 'pending' ? 'pending' : (item.status === 'rejected' ? 'rejected' : '')}}">
              <text wx:if="{{item.status === 'pending'}}">å¾…å®¡æ ¸</text>
              <text wx:elif="{{item.status === 'rejected'}}">å·²æ‹’ç»</text>
              <text wx:else>+{{item.finalPoints || item.points}}</text>
            </view>
          </view>
          <view class="record-body">
            <view class="record-chore">
              <text class="record-emoji">{{item.choreType.icon || 'ğŸ§¹'}}</text>
              <text class="record-chore-name">{{item.choreType.name}}</text>
            </view>
            <text class="record-remark" wx:if="{{item.remark}}">{{item.remark}}</text>
            <!-- æ˜¾ç¤ºç…§ç‰‡ -->
            <view class="record-images" wx:if="{{item.images && item.images.length > 0}}">
              <image 
                wx:for="{{item.images}}" 
                wx:for-item="img" 
                wx:key="*this" 
                class="record-img" 
                src="{{img}}" 
                mode="aspectFill"
                bindtap="previewRecordImage"
                data-urls="{{item.images}}"
                data-current="{{img}}"
              ></image>
            </view>
            <!-- æ‰£åˆ†è¯´æ˜ -->
            <view class="deduction-info" wx:if="{{item.deduction > 0}}">
              <text class="deduction-text">æ‰£{{item.deduction}}åˆ†: {{item.deductionReason}}</text>
            </view>
          </view>
          <view class="record-footer">
            <text class="record-time">{{item.createdAtText}}</text>
          </view>
        </view>
      </view>

      <view class="list-footer">
        <text class="footer-text" wx:if="{{hasMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
        <text class="footer-text" wx:else>â€” æ²¡æœ‰æ›´å¤šäº† â€”</text>
      </view>
    </view>

    <view class="empty-state" wx:else>
      <view class="empty-icon animate-float">ğŸ“‹</view>
      <text class="empty-title">è¿˜æ²¡æœ‰å®¶åŠ¡è®°å½•</text>
      <text class="empty-desc">å¿«å»è®°å½•ç¬¬ä¸€æ¡å®¶åŠ¡å§</text>
    </view>
  </view>

  <!-- å®¡æ ¸åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰ -->
  <view class="tab-content" wx:if="{{activeTab === 'review' && isAdmin}}">
    <view class="records-list" wx:if="{{pendingRecords.length > 0}}">
      <view class="record-card review-card" wx:for="{{pendingRecords}}" wx:key="id">
        <view class="record-color-bar bar-pending"></view>
        <view class="record-main">
          <view class="record-header">
            <view class="record-user">
              <image class="record-avatar" src="{{item.userAvatar || '/assets/images/default-avatar.png'}}"></image>
              <text class="record-username">{{item.userNickname}}</text>
            </view>
            <view class="record-points-tag pending">
              <text>å¾…å®¡æ ¸ +{{item.points}}</text>
            </view>
          </view>
          <view class="record-body">
            <view class="record-chore">
              <text class="record-emoji">{{item.choreIcon || 'ğŸ§¹'}}</text>
              <text class="record-chore-name">{{item.choreName}}</text>
            </view>
            <text class="record-remark" wx:if="{{item.note}}">{{item.note}}</text>
            <!-- æ˜¾ç¤ºç…§ç‰‡ -->
            <view class="record-images" wx:if="{{item.images && item.images.length > 0}}">
              <image 
                wx:for="{{item.images}}" 
                wx:for-item="img" 
                wx:key="*this" 
                class="record-img" 
                src="{{img}}" 
                mode="aspectFill"
                bindtap="previewRecordImage"
                data-urls="{{item.images}}"
                data-current="{{img}}"
              ></image>
            </view>
          </view>
          <view class="record-footer">
            <text class="record-time">{{item.completedAtText}}</text>
          </view>
          <!-- å®¡æ ¸æ“ä½œ -->
          <view class="review-actions">
            <button class="review-btn reject" catchtap="rejectRecord" data-record="{{item}}">
              <text>âŒ æ‹’ç»</text>
            </button>
            <button class="review-btn deduct" catchtap="showDeductModal" data-record="{{item}}">
              <text>âš ï¸ æ‰£åˆ†é€šè¿‡</text>
            </button>
            <button class="review-btn approve" catchtap="approveRecord" data-record="{{item}}">
              <text>âœ… é€šè¿‡</text>
            </button>
          </view>
        </view>
      </view>
    </view>

    <view class="empty-state" wx:else>
      <view class="empty-icon animate-float">âœ…</view>
      <text class="empty-title">æš‚æ— å¾…å®¡æ ¸è®°å½•</text>
      <text class="empty-desc">æ‰€æœ‰å®¶åŠ¡éƒ½å·²å®¡æ ¸å®Œæ¯•</text>
    </view>
  </view>

  <!-- FAB æµ®åŠ¨æŒ‰é’® -->
  <view class="fab" bindtap="showQuickRecord" wx:if="{{familyInfo && choreTypes.length > 0}}">
    <text class="fab-icon">+</text>
  </view>

  <!-- è®°å½•å¼¹çª— -->
  <view class="modal-overlay {{showRecordModal ? 'show' : ''}}" bindtap="closeRecordModal">
    <view class="modal-container" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">è®°å½•å®¶åŠ¡</text>
        <view class="modal-close" bindtap="closeRecordModal">
          <text>âœ•</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="selected-chore-card">
          <view class="selected-icon">
            <text class="icon-emoji">{{selectedChoreType.icon || 'ğŸ§¹'}}</text>
          </view>
          <view class="selected-info">
            <text class="selected-name">{{selectedChoreType.name}}</text>
            <view class="selected-points">
              <text class="points-value">+{{selectedChoreType.points}}</text>
              <text class="points-label">ç§¯åˆ†</text>
            </view>
          </view>
        </view>

        <!-- ç…§ç‰‡ä¸Šä¼  -->
        <view class="photo-section">
          <text class="photo-label">ä¸Šä¼ ç…§ç‰‡ï¼ˆå¯é€‰ï¼Œæœ€å¤š3å¼ ï¼‰</text>
          <view class="photo-grid">
            <view class="photo-item" wx:for="{{selectedImages}}" wx:key="index">
              <image class="photo-img" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}"></image>
              <view class="photo-delete" catchtap="removeImage" data-index="{{index}}">Ã—</view>
            </view>
            <view class="photo-add" bindtap="chooseImage" wx:if="{{selectedImages.length < 3}}">
              <text class="add-icon">ğŸ“·</text>
              <text class="add-text">æ·»åŠ ç…§ç‰‡</text>
            </view>
          </view>
          <text class="photo-hint" wx:if="{{!isAdmin}}">ğŸ’¡ æç¤ºï¼šä¸Šä¼ ç…§ç‰‡åéœ€è¦å®¶é•¿å®¡æ ¸å“¦</text>
        </view>

        <view class="remark-section">
          <text class="remark-label">æ·»åŠ å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</text>
          <textarea 
            class="remark-input" 
            placeholder="è®°å½•ä¸€ä¸‹è¿™æ¬¡å®¶åŠ¡çš„å¿ƒæƒ…..."
            value="{{remark}}"
            bindinput="onRemarkInput"
            maxlength="200"
          ></textarea>
          <text class="remark-count">{{remark.length || 0}}/200</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button 
          class="submit-btn" 
          bindtap="submitRecord"
          loading="{{isSubmitting}}"
          disabled="{{isSubmitting}}"
        >
          <text wx:if="{{!isSubmitting}}">âœ… ç¡®è®¤æäº¤</text>
          <text wx:else>æäº¤ä¸­...</text>
        </button>
      </view>
    </view>
  </view>

  <!-- æ‰£åˆ†å¼¹çª— -->
  <view class="modal-overlay {{showDeductModal ? 'show' : ''}}" bindtap="closeDeductModal">
    <view class="modal-container deduct-modal" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">æ‰£åˆ†å®¡æ ¸</text>
        <view class="modal-close" bindtap="closeDeductModal">
          <text>âœ•</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="deduct-info">
          <text class="deduct-label">åŸå§‹ç§¯åˆ†</text>
          <text class="deduct-value">+{{deductingRecord.points}}åˆ†</text>
        </view>

        <view class="deduct-section">
          <text class="deduct-label">æ‰£é™¤ç§¯åˆ†</text>
          <view class="deduct-slider">
            <slider 
              min="0" 
              max="{{deductingRecord.points}}" 
              value="{{deductAmount}}"
              activeColor="#FF6B6B"
              backgroundColor="#e5e5e5"
              block-size="20"
              bindchange="onDeductChange"
            />
            <text class="deduct-amount">-{{deductAmount}}åˆ†</text>
          </view>
          <text class="final-points">æœ€ç»ˆè·å¾—: {{deductingRecord.points - deductAmount}}åˆ†</text>
        </view>

        <view class="deduct-section">
          <text class="deduct-label">æ‰£åˆ†åŸå› </text>
          <textarea 
            class="deduct-input"
            placeholder="è¯·å¡«å†™æ‰£åˆ†åŸå› ï¼Œå¦‚ï¼šå®Œæˆè´¨é‡ä¸ä½³ã€æœªæ¸…ç†å¹²å‡€ç­‰..."
            value="{{deductReason}}"
            bindinput="onDeductReasonInput"
            maxlength="100"
          ></textarea>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeDeductModal">å–æ¶ˆ</button>
        <button 
          class="confirm-btn" 
          bindtap="confirmDeduct"
          loading="{{isReviewing}}"
          disabled="{{isReviewing}}"
        >ç¡®è®¤æ‰£åˆ†é€šè¿‡</button>
      </view>
    </view>
  </view>
</view>
