<!--pages/chores/chores.wxml - 3Dæç®€ç§‘æŠ€ç‰ˆ-->
<view class="page-container">
  <!-- é¡¶éƒ¨æ ‡ç­¾åˆ‡æ¢ (Glassmorphism Tabs) -->
  <view class="tabs-wrapper">
    <view class="glass-card tabs {{isAdmin ? 'tabs-3' : 'tabs-2'}}">
      <view class="tab-item {{activeTab === 'record' ? 'active' : ''}}" data-tab="record" bindtap="switchTab">è®°å½•</view>
      <view class="tab-item {{activeTab === 'history' ? 'active' : ''}}" data-tab="history" bindtap="switchTab">å†å²</view>
      <view class="tab-item {{activeTab === 'review' ? 'active' : ''}}" data-tab="review" bindtap="switchTab" wx:if="{{isAdmin}}">å®¡æ ¸</view>
      <view class="tab-indicator {{activeTab === 'history' ? 'pos-2' : (activeTab === 'review' ? 'pos-3' : '')}}"></view>
    </view>
  </view>

  <!-- è®°å½•å®¶åŠ¡å†…å®¹ -->
  <view class="tab-content" wx:if="{{activeTab === 'record'}}">
    <view class="hero-section">
      <view class="hero-bg-glow"></view>
      <view class="hero-title">è®°å½•å®¶åŠ¡</view>
      <view class="hero-subtitle">Record Your Chores</view>
    </view>

    <!-- å®¶åŠ¡ç±»å‹ç½‘æ ¼ -->
    <view class="chore-grid">
      <view class="chore-card glass-card success-pop" 
            wx:for="{{choreTypes}}" 
            wx:key="id"
            data-item="{{item}}"
            bindtap="selectChoreType">
        <view class="chore-icon">{{item.icon || 'ğŸ§¹'}}</view>
        <view class="chore-info">
          <text class="chore-name">{{item.name}}</text>
          <text class="chore-points">+{{item.points}} ç§¯åˆ†</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½•å†…å®¹ -->
  <view class="tab-content" wx:if="{{activeTab === 'history'}}">
    <view class="hero-section">
      <view class="hero-bg-glow"></view>
      <view class="hero-title">å†å²è®°å½•</view>
      <view class="hero-subtitle">History Records</view>
    </view>

    <view class="record-list">
      <view class="record-item glass-card" wx:for="{{choreRecords}}" wx:key="id">
        <view class="record-header">
          <image class="user-avatar" src="{{item.user.avatarUrl || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
          <view class="user-info">
            <text class="user-name">{{item.user.nickname}}</text>
            <text class="record-time">{{item.createdAtText}}</text>
          </view>
          <view class="points-badge {{item.status}}">+{{item.finalPoints || item.points}}</view>
        </view>
        <view class="record-body">
          <text class="chore-type-name">{{item.choreType.name}}</text>
          <text class="record-remark" wx:if="{{item.remark}}">{{item.remark}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å®¡æ ¸å†…å®¹ (ç®¡ç†å‘˜) -->
  <view class="tab-content" wx:if="{{activeTab === 'review' && isAdmin}}">
    <view class="hero-section">
      <view class="hero-bg-glow"></view>
      <view class="hero-title">å¾…å®¡æ ¸</view>
      <view class="hero-subtitle">Pending Review</view>
    </view>

    <view class="review-list">
      <view class="review-item glass-card" wx:for="{{pendingRecords}}" wx:key="id">
        <view class="record-header">
          <image class="user-avatar" src="{{item.userAvatar || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
          <view class="user-info">
            <text class="user-name">{{item.userNickname}}</text>
            <text class="record-time">{{item.completedAtText}}</text>
          </view>
        </view>
        <view class="review-body">
          <text class="chore-type-name">{{item.choreName}}</text>
          <text class="record-remark" wx:if="{{item.note}}">{{item.note}}</text>
        </view>
        <view class="review-actions">
          <view class="action-btn reject btn-active-feedback" catchtap="rejectRecord" data-record="{{item}}">æ‹’ç»</view>
          <view class="action-btn approve btn-active-feedback" catchtap="showDeductModal" data-record="{{item}}">é€šè¿‡</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-bottom"></view>

  <!-- è®°å½•å®¶åŠ¡å¼¹çª— -->
  <view class="modal-mask {{showRecordModal ? 'show' : ''}}" bindtap="closeRecordModal">
    <view class="modal-content glass-card {{showRecordModal ? 'show' : ''}}" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">è®°å½•{{selectedChoreType.name}}</text>
        <view class="close-btn" bindtap="closeRecordModal">Ã—</view>
      </view>
      
      <scroll-view scroll-y class="modal-body">
        <view class="form-item">
          <text class="form-label">å¤‡æ³¨ä¿¡æ¯</text>
          <textarea class="form-textarea" placeholder="æœ‰ä»€ä¹ˆæƒ³è¯´çš„å—ï¼Ÿ" value="{{remark}}" bindinput="onRemarkInput" />
        </view>

        <view class="form-item">
          <text class="form-label">ä¸Šä¼ ç…§ç‰‡ (å¯é€‰)</text>
          <view class="image-picker">
            <view class="image-item" wx:for="{{selectedImages}}" wx:key="*this">
              <image src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}" />
              <view class="remove-icon" catchtap="removeImage" data-index="{{index}}">Ã—</view>
            </view>
            <view class="add-image-btn btn-active-feedback" bindtap="chooseImage" wx:if="{{selectedImages.length < 3}}">
              <text>+</text>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <view class="primary-btn submit-btn btn-active-feedback" bindtap="submitRecord">
          <text>ç¡®è®¤æäº¤</text>
          <view class="btn-glow"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- å®¡æ ¸æ‰£åˆ†å¼¹çª— -->
  <view class="modal-mask {{showDeductModal ? 'show' : ''}}" bindtap="closeDeductModal">
    <view class="modal-content glass-card {{showDeductModal ? 'show' : ''}}" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">å®¡æ ¸ç¡®è®¤</text>
        <view class="close-btn" bindtap="closeDeductModal">Ã—</view>
      </view>
      
      <scroll-view scroll-y class="modal-body">
        <view class="detail-main">
          <text class="detail-title">{{deductingRecord.userNickname}} çš„ {{deductingRecord.choreName}}</text>
          <text class="detail-subtitle">æ ‡å‡†ç§¯åˆ†: {{deductingRecord.points}}</text>
        </view>

        <view class="form-item">
          <text class="form-label">æ‰£é™¤ç§¯åˆ†: {{deductAmount}}</text>
          <slider min="0" max="{{deductingRecord.points}}" value="{{deductAmount}}" bindchange="onDeductChange" activeColor="#ff4d4f" />
          <text class="form-desc">å®å¾—ç§¯åˆ†: {{deductingRecord.points - deductAmount}}</text>
        </view>

        <view class="form-item" wx:if="{{deductAmount > 0}}">
          <text class="form-label">æ‰£åˆ†åŸå› </text>
          <textarea class="form-textarea" placeholder="è¯·è¯´æ˜æ‰£åˆ†åŸå› ï¼Œå¦‚ï¼šå®Œæˆä¸å½»åº•" value="{{deductReason}}" bindinput="onDeductReasonInput" />
        </view>
      </scroll-view>

      <view class="modal-footer detail-footer">
        <view class="delete-btn btn-active-feedback" bindtap="closeDeductModal">å–æ¶ˆ</view>
        <view class="primary-btn edit-btn btn-active-feedback" bindtap="confirmDeduct">
          <text>ç¡®è®¤é€šè¿‡</text>
          <view class="btn-glow"></view>
        </view>
      </view>
    </view>
  </view>
</view>