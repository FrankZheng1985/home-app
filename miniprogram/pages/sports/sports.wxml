<!--pages/sports/sports.wxml - è¿åŠ¨æ‰“å¡é¡µé¢-->
<view class="sports-page">
  <!-- åŠ è½½ä¸­ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-icon">â³</view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- æœªåŠ å…¥å®¶åº­æç¤º -->
  <view class="no-family-container" wx:elif="{{!hasFamily}}">
    <view class="no-family-icon">ğŸ </view>
    <text class="no-family-title">è¯·å…ˆåŠ å…¥å®¶åº­</text>
    <text class="no-family-desc">åŠ å…¥å®¶åº­åæ‰èƒ½ä½¿ç”¨è¿åŠ¨æ‰“å¡åŠŸèƒ½</text>
    <button class="join-family-btn" bindtap="goToFamily">å»åŠ å…¥å®¶åº­</button>
  </view>

  <!-- ä¸»å†…å®¹ï¼ˆå·²åŠ å…¥å®¶åº­ï¼‰ -->
  <block wx:else>
  <!-- å¤´éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="header-card">
    <view class="header-bg"></view>
    <view class="header-content">
      <!-- ä»Šæ—¥æ­¥æ•° -->
      <view class="steps-section">
        <view class="steps-icon">ğŸƒ</view>
        <view class="steps-info">
          <text class="steps-label">ä»Šæ—¥æ­¥æ•°</text>
          <view class="steps-row">
            <text class="steps-value">{{todaySteps}}</text>
            <text class="steps-unit">æ­¥</text>
          </view>
          <view class="steps-target">
            <text>ç›®æ ‡ {{stepsTarget}} æ­¥</text>
            <text class="steps-progress">{{stepsProgress}}%</text>
          </view>
        </view>
        <view class="sync-btn" bindtap="doSyncSteps">
          <text class="sync-icon">ğŸ”„</text>
          <text class="sync-text">åŒæ­¥</text>
        </view>
      </view>
      
      <!-- è¿›åº¦æ¡ -->
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{stepsProgress > 100 ? 100 : stepsProgress}}%"></view>
      </view>
      
      <!-- ç»Ÿè®¡æ•°æ® -->
      <view class="stats-row">
        <view class="stat-item">
          <text class="stat-value">{{weekStats.totalDays || 0}}</text>
          <text class="stat-label">æœ¬å‘¨æ‰“å¡</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value">{{weekStats.totalMinutes || 0}}</text>
          <text class="stat-label">è¿åŠ¨åˆ†é’Ÿ</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value">{{continuousDays || 0}}</text>
          <text class="stat-label">è¿ç»­æ‰“å¡</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰“å¡æ—¥å† -->
  <view class="calendar-section">
    <view class="section-header">
      <text class="section-title">ğŸ“… æœ¬å‘¨æ‰“å¡</text>
    </view>
    <view class="week-calendar">
      <view 
        class="calendar-day {{item.isToday ? 'today' : ''}} {{item.checked ? 'checked' : ''}}"
        wx:for="{{weekDays}}" 
        wx:key="date"
      >
        <text class="day-name">{{item.dayName}}</text>
        <text class="day-date">{{item.day}}</text>
        <view class="check-mark" wx:if="{{item.checked}}">âœ“</view>
      </view>
    </view>
  </view>

  <!-- ä»Šæ—¥æ‰“å¡ -->
  <view class="checkin-section">
    <view class="section-header">
      <text class="section-title">ğŸ’ª ä»Šæ—¥è¿åŠ¨</text>
      <view class="add-btn" bindtap="showAddModal">
        <text>+ è®°å½•</text>
      </view>
    </view>
    
    <!-- å·²æ‰“å¡è®°å½• -->
    <view class="checkin-list" wx:if="{{todayRecords.length > 0}}">
      <view class="checkin-card" wx:for="{{todayRecords}}" wx:key="id">
        <view class="checkin-icon" style="background: {{item.color || '#667eea'}}">
          <text>{{item.icon || 'ğŸƒ'}}</text>
        </view>
        <view class="checkin-info">
          <text class="checkin-name">{{item.sportType}}</text>
          <text class="checkin-detail">{{item.duration}}åˆ†é’Ÿ Â· {{item.calories || 0}}åƒå¡</text>
        </view>
        <view class="checkin-time">{{item.timeText}}</view>
      </view>
    </view>
    
    <!-- å¿«é€Ÿæ‰“å¡ -->
    <view class="quick-checkin" wx:else>
      <text class="quick-tip">é€‰æ‹©è¿åŠ¨ç±»å‹å¿«é€Ÿæ‰“å¡</text>
      <view class="sport-types">
        <view 
          class="sport-type-card" 
          wx:for="{{sportTypes}}" 
          wx:key="id"
          data-type="{{item}}"
          bindtap="quickCheckin"
        >
          <view class="type-icon" style="background: {{item.color}}">
            <text>{{item.icon}}</text>
          </view>
          <text class="type-name">{{item.name}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¿åŠ¨ç±»å‹ç®¡ç† -->
  <view class="types-section">
    <view class="section-header">
      <text class="section-title">ğŸ¯ è¿åŠ¨ç±»å‹</text>
      <view class="manage-btn" bindtap="showTypeModal">
        <text>ç®¡ç†</text>
      </view>
    </view>
    <view class="types-grid">
      <view 
        class="type-item" 
        wx:for="{{sportTypes}}" 
        wx:key="id"
        data-type="{{item}}"
        bindtap="selectSportType"
      >
        <view class="type-icon-small" style="background: {{item.color}}">
          <text>{{item.icon}}</text>
        </view>
        <text class="type-label">{{item.name}}</text>
        <text class="type-calories">{{item.caloriesPerMin}}åƒå¡/åˆ†</text>
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½• -->
  <view class="history-section">
    <view class="section-header">
      <text class="section-title">ğŸ“Š è¿åŠ¨å†å²</text>
    </view>
    <view class="history-list" wx:if="{{historyRecords.length > 0}}">
      <view class="history-item" wx:for="{{historyRecords}}" wx:key="id">
        <view class="history-date">
          <text class="date-day">{{item.dayText}}</text>
          <text class="date-weekday">{{item.weekdayText}}</text>
        </view>
        <view class="history-content">
          <view class="history-sport">
            <text class="sport-icon">{{item.icon || 'ğŸƒ'}}</text>
            <text class="sport-name">{{item.sportType}}</text>
          </view>
          <view class="history-stats">
            <text>{{item.duration}}åˆ†é’Ÿ</text>
            <text class="dot">Â·</text>
            <text>{{item.calories || 0}}åƒå¡</text>
          </view>
        </view>
        <view class="history-steps" wx:if="{{item.steps}}">
          <text class="steps-num">{{item.steps}}</text>
          <text class="steps-text">æ­¥</text>
        </view>
      </view>
    </view>
    <view class="empty-history" wx:else>
      <text class="empty-icon">ğŸƒ</text>
      <text class="empty-text">è¿˜æ²¡æœ‰è¿åŠ¨è®°å½•ï¼Œå¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡è¿åŠ¨å§ï¼</text>
    </view>
  </view>

  <!-- æ·»åŠ è¿åŠ¨å¼¹çª— -->
  <view class="modal-overlay {{showAddModal ? 'show' : ''}}" bindtap="closeAddModal">
    <view class="modal-container" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">ğŸƒ è®°å½•è¿åŠ¨</text>
        <view class="modal-close" bindtap="closeAddModal">Ã—</view>
      </view>
      <view class="modal-body">
        <!-- è¿åŠ¨ç±»å‹é€‰æ‹© -->
        <view class="form-group">
          <text class="form-label">è¿åŠ¨ç±»å‹</text>
          <view class="type-selector">
            <view 
              class="type-option {{selectedType && selectedType.id === item.id ? 'selected' : ''}}"
              wx:for="{{sportTypes}}" 
              wx:key="id"
              data-type="{{item}}"
              bindtap="selectType"
            >
              <text class="option-icon">{{item.icon}}</text>
              <text class="option-name">{{item.name}}</text>
            </view>
          </view>
        </view>
        
        <!-- è¿åŠ¨æ—¶é•¿ -->
        <view class="form-group">
          <text class="form-label">è¿åŠ¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</text>
          <view class="duration-selector">
            <view class="duration-btn" bindtap="decreaseDuration">-</view>
            <input 
              class="duration-input" 
              type="number" 
              value="{{duration}}" 
              bindinput="onDurationInput"
            />
            <view class="duration-btn" bindtap="increaseDuration">+</view>
          </view>
          <view class="quick-durations">
            <view class="quick-dur" data-dur="15" bindtap="setQuickDuration">15åˆ†é’Ÿ</view>
            <view class="quick-dur" data-dur="30" bindtap="setQuickDuration">30åˆ†é’Ÿ</view>
            <view class="quick-dur" data-dur="45" bindtap="setQuickDuration">45åˆ†é’Ÿ</view>
            <view class="quick-dur" data-dur="60" bindtap="setQuickDuration">60åˆ†é’Ÿ</view>
          </view>
        </view>
        
        <!-- å¤‡æ³¨ -->
        <view class="form-group">
          <text class="form-label">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</text>
          <textarea 
            class="remark-input" 
            placeholder="è®°å½•ä¸€ä¸‹è¿™æ¬¡è¿åŠ¨çš„æ„Ÿå—..."
            value="{{remark}}"
            bindinput="onRemarkInput"
            maxlength="200"
          ></textarea>
        </view>
        
        <!-- é¢„ä¼°æ¶ˆè€— -->
        <view class="calories-preview" wx:if="{{selectedType}}">
          <text class="preview-label">é¢„ä¼°æ¶ˆè€—</text>
          <text class="preview-value">{{estimatedCalories}} åƒå¡</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeAddModal">å–æ¶ˆ</button>
        <button 
          class="confirm-btn" 
          bindtap="submitRecord"
          disabled="{{!selectedType || duration <= 0 || isSubmitting}}"
        >
          {{isSubmitting ? 'æäº¤ä¸­...' : 'å®Œæˆæ‰“å¡'}}
        </button>
      </view>
    </view>
  </view>

  <!-- ç®¡ç†è¿åŠ¨ç±»å‹å¼¹çª— -->
  <view class="modal-overlay {{showTypeModal ? 'show' : ''}}" bindtap="closeTypeModal">
    <view class="modal-container type-modal" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">ğŸ¯ ç®¡ç†è¿åŠ¨ç±»å‹</text>
        <view class="modal-close" bindtap="closeTypeModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="type-list">
          <view class="type-list-item" wx:for="{{sportTypes}}" wx:key="id">
            <view class="type-icon-small" style="background: {{item.color}}">
              <text>{{item.icon}}</text>
            </view>
            <text class="type-name">{{item.name}}</text>
            <text class="type-cal">{{item.caloriesPerMin}}åƒå¡/åˆ†</text>
            <view 
              class="type-delete" 
              wx:if="{{!item.isPreset}}"
              data-id="{{item.id}}"
              bindtap="deleteType"
            >ğŸ—‘ï¸</view>
          </view>
        </view>
        
        <!-- æ·»åŠ æ–°ç±»å‹ -->
        <view class="add-type-form">
          <text class="form-subtitle">æ·»åŠ æ–°è¿åŠ¨ç±»å‹</text>
          <view class="add-type-row">
            <input 
              class="type-name-input" 
              placeholder="è¿åŠ¨åç§°"
              value="{{newTypeName}}"
              bindinput="onNewTypeNameInput"
            />
            <input 
              class="type-cal-input" 
              type="digit"
              placeholder="åƒå¡/åˆ†"
              value="{{newTypeCalories}}"
              bindinput="onNewTypeCaloriesInput"
            />
            <view class="add-type-btn" bindtap="addNewType">æ·»åŠ </view>
          </view>
        </view>
      </view>
    </view>
  </view>
  </block>
</view>

