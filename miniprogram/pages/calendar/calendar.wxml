<!--pages/calendar/calendar.wxml - 3Dæç®€ç§‘æŠ€ç‰ˆ-->
<view class="page-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="hero-section">
    <view class="hero-bg-glow"></view>
    <view class="hero-content page-fade-in">
      <view class="hero-title">{{currentMonthText}}</view>
      <view class="hero-subtitle">Family Shared Calendar</view>
    </view>
  </view>

  <!-- æ—¥å†é¢æ¿ (Glassmorphism Card) -->
  <view class="glass-card calendar-panel success-pop">
    <view class="calendar-header">
      <view class="month-nav btn-active-feedback" bindtap="prevMonth">â€¹</view>
      <view class="current-date">{{currentYear}}å¹´{{currentMonth}}æœˆ</view>
      <view class="month-nav btn-active-feedback" bindtap="nextMonth">â€º</view>
    </view>
    
    <view class="week-days">
      <text wx:for="{{weekDays}}" wx:key="*this">{{item}}</text>
    </view>
    
    <view class="days-grid">
      <view 
        class="day-item {{item.isCurrentMonth ? '' : 'not-current'}} {{item.isToday ? 'today' : ''}} {{selectedDate === item.fullDate ? 'selected' : ''}}" 
        wx:for="{{days}}" 
        wx:key="fullDate"
        data-date="{{item.fullDate}}"
        bindtap="selectDate"
      >
        <text class="day-num">{{item.day}}</text>
        <view class="event-dots" wx:if="{{item.hasEvents}}">
          <view class="dot" style="background: {{item.eventColor || '#000'}}"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ—¥ç¨‹åˆ—è¡¨ -->
  <view class="section-header">
    <text class="section-title">{{selectedDateText}} æ—¥ç¨‹</text>
    <view class="add-btn-mini btn-active-feedback" bindtap="showAddModal">æ·»åŠ æ—¥ç¨‹</view>
  </view>

  <view class="event-list">
    <view class="event-item glass-card" wx:for="{{selectedEvents}}" wx:key="id" bindtap="showEventDetail" data-id="{{item.id}}">
      <view class="event-time-box">
        <text class="time-start">{{item.startTimeText}}</text>
        <view class="time-line" style="background: {{item.categoryColor || '#000'}}"></view>
      </view>
      <view class="event-content">
        <text class="event-title">{{item.title}}</text>
        <view class="event-meta">
          <text class="event-location" wx:if="{{item.location}}">ğŸ“ {{item.location}}</text>
          <text class="event-category" style="color: {{item.categoryColor}}">{{item.categoryName}}</text>
        </view>
      </view>
      <text class="arrow">â€º</text>
    </view>
    
    <view class="empty-tip" wx:if="{{selectedEvents.length === 0}}">
      <view class="empty-icon">ğŸ“…</view>
      <text>ä»Šæ—¥æš‚æ— å®‰æ’ï¼Œäº«å—æ‚ é—²æ—¶å…‰å§</text>
    </view>
  </view>

  <view class="safe-bottom"></view>

  <!-- æ·»åŠ /ç¼–è¾‘æ—¥ç¨‹å¼¹çª— -->
  <view class="modal-mask {{showAddModal ? 'show' : ''}}" bindtap="hideAddModal">
    <view class="modal-content glass-card {{showAddModal ? 'show' : ''}}" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">{{editMode === 'add' ? 'æ–°å¢æ—¥ç¨‹' : 'ç¼–è¾‘æ—¥ç¨‹'}}</text>
        <view class="close-btn" bindtap="hideAddModal">Ã—</view>
      </view>
      
      <scroll-view scroll-y class="modal-body">
        <view class="form-item">
          <text class="form-label">æ—¥ç¨‹æ ‡é¢˜</text>
          <input class="form-input" placeholder="æƒ³åšäº›ä»€ä¹ˆï¼Ÿ" value="{{formData.title}}" data-field="title" bindinput="onInput" />
        </view>

        <view class="form-item">
          <text class="form-label">é€‰æ‹©åˆ†ç±»</text>
          <view class="category-grid">
            <view 
              wx:for="{{categories}}" 
              wx:key="id" 
              class="category-item {{formData.categoryId === item.id ? 'active' : ''}}"
              style="--cat-color: {{item.color}}"
              data-id="{{item.id}}"
              bindtap="onCategorySelect"
            >
              <view class="cat-dot" style="background: {{item.color}}"></view>
              <text>{{item.name}}</text>
            </view>
          </view>
        </view>

        <view class="form-row">
          <view class="form-item half">
            <text class="form-label">å¼€å§‹æ—¶é—´</text>
            <picker mode="selector" range="{{timeRange}}" value="{{startTimeIndex}}" bindchange="onStartTimeChange">
              <view class="picker-val">{{timeRange[startTimeIndex]}}</view>
            </picker>
          </view>
          <view class="form-item half">
            <text class="form-label">ç»“æŸæ—¶é—´</text>
            <picker mode="selector" range="{{timeRange}}" value="{{endTimeIndex}}" bindchange="onEndTimeChange">
              <view class="picker-val">{{timeRange[endTimeIndex]}}</view>
            </picker>
          </view>
        </view>

        <view class="form-item">
          <text class="form-label">åœ°ç‚¹</text>
          <input class="form-input" placeholder="åœ¨å“ªé‡Œï¼Ÿ" value="{{formData.location}}" data-field="location" bindinput="onInput" />
        </view>

        <view class="form-item">
          <text class="form-label">å¤‡æ³¨</text>
          <textarea class="form-textarea" placeholder="è¿˜æœ‰ä»€ä¹ˆéœ€è¦æ³¨æ„çš„ï¼Ÿ" value="{{formData.description}}" data-field="description" bindinput="onInput" />
        </view>
      </scroll-view>

      <view class="modal-footer">
        <view class="primary-btn submit-btn btn-active-feedback" bindtap="submitEvent">
          <text>ç¡®è®¤æ·»åŠ </text>
          <view class="btn-glow"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ—¥ç¨‹è¯¦æƒ…å¼¹çª— -->
  <view class="modal-mask {{showDetailModal ? 'show' : ''}}" bindtap="hideDetailModal">
    <view class="modal-content glass-card {{showDetailModal ? 'show' : ''}}" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">æ—¥ç¨‹è¯¦æƒ…</text>
        <view class="close-btn" bindtap="hideDetailModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="detail-main">
          <view class="detail-category-tag" style="background: {{selectedEventDetail.categoryColor}}">
            {{selectedEventDetail.categoryName}}
          </view>
          <text class="detail-title">{{selectedEventDetail.title}}</text>
        </view>

        <view class="detail-info-list">
          <view class="detail-info-item">
            <text class="info-icon">â°</text>
            <text class="info-text">{{selectedEventDetail.startTimeText}}</text>
          </view>
          <view class="detail-info-item" wx:if="{{selectedEventDetail.location}}">
            <text class="info-icon">ğŸ“</text>
            <text class="info-text">{{selectedEventDetail.location}}</text>
          </view>
          <view class="detail-info-item" wx:if="{{selectedEventDetail.description}}">
            <text class="info-icon">ğŸ“</text>
            <text class="info-text">{{selectedEventDetail.description}}</text>
          </view>
        </view>
      </view>

      <view class="modal-footer detail-footer">
        <view class="delete-btn btn-active-feedback" bindtap="deleteEvent">åˆ é™¤</view>
        <view class="secondary-btn btn-active-feedback" style="flex: 1; height: 110rpx; border-radius: 55rpx;" bindtap="showEditModal">ç¼–è¾‘</view>
        <view class="primary-btn edit-btn btn-active-feedback" style="flex: 1.5" bindtap="hideDetailModal">
          <text>ç¡®å®š</text>
          <view class="btn-glow"></view>
        </view>
      </view>
    </view>
  </view>
</view>