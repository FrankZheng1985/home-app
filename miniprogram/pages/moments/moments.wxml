<!--pages/moments/moments.wxml - ç²¾ç¾è®¾è®¡ç‰ˆ (æ”¯æŒå›¾ç‰‡ä¸Šä¼ )-->
<view class="moments-page">
  <!-- æ¸å˜å¤´éƒ¨ -->
  <view class="moments-header">
    <view class="header-bg"></view>
    <view class="header-content">
      <text class="header-title">ğŸ’¬ å®¶åº­åŠ¨æ€</text>
      <text class="header-subtitle">åˆ†äº«ç”Ÿæ´»ç‚¹æ»´ï¼Œè®°å½•ç¾å¥½æ—¶å…‰</text>
    </view>
  </view>

  <!-- æ— å®¶åº­æç¤º -->
  <view class="empty-state" wx:if="{{!familyInfo}}">
    <view class="empty-icon animate-float">ğŸ </view>
    <text class="empty-title">è¯·å…ˆåŠ å…¥å®¶åº­</text>
    <text class="empty-desc">åŠ å…¥å®¶åº­åï¼Œæ‰èƒ½æŸ¥çœ‹å’Œå‘å¸ƒåŠ¨æ€å“¦</text>
  </view>

  <view class="moments-content" wx:else>
    <!-- å‘å¸ƒå…¥å£ -->
    <view class="publish-entry" bindtap="openPublishModal">
      <view class="publish-avatar-wrap">
        <image class="publish-avatar" src="{{userInfo.avatarUrl || '/assets/images/default-avatar.png'}}"></image>
      </view>
      <view class="publish-placeholder">
        <text>âœï¸ åˆ†äº«ä¸€ä¸‹ä»Šå¤©çš„å¿ƒæƒ…...</text>
      </view>
      <view class="publish-btn-icon">
        <text>ğŸ“·</text>
      </view>
    </view>

    <!-- åŠ¨æ€åˆ—è¡¨ -->
    <view class="posts-list" wx:if="{{posts.length > 0}}">
      <view class="post-card" wx:for="{{posts}}" wx:key="id">
        <!-- ä½œè€…ä¿¡æ¯ -->
        <view class="post-header">
          <view class="post-author">
            <view class="author-avatar-wrap">
              <image 
                class="author-avatar" 
                src="{{item.isAnonymous ? '/assets/images/default-avatar.png' : (item.user.avatarUrl || item.user.avatar_url || '/assets/images/default-avatar.png')}}"
              ></image>
              <view class="anonymous-mask" wx:if="{{item.isAnonymous}}">
                <text>ğŸ™ˆ</text>
              </view>
            </view>
            <view class="author-info">
              <text class="author-name">{{item.isAnonymous ? 'åŒ¿åå®¶äºº' : item.user.nickname}}</text>
              <text class="post-time">{{item.createdAtText}}</text>
            </view>
          </view>
          
          <!-- æ›´å¤šæ“ä½œï¼ˆå‘å¸ƒäººå¯åˆ é™¤ï¼‰ -->
          <view 
            class="post-more" 
            wx:if="{{item.isOwner || item.userId === currentUserId || (item.user && item.user.id === currentUserId)}}"
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="showPostActions"
          >
            <text class="more-icon">â€¢â€¢â€¢</text>
          </view>
        </view>

        <!-- å†…å®¹ -->
        <view class="post-body">
          <text class="post-content">{{item.content}}</text>
          
          <!-- å›¾ç‰‡ç½‘æ ¼ -->
          <view class="post-images {{item.images.length === 1 ? 'single' : (item.images.length === 2 ? 'double' : (item.images.length === 4 ? 'quad' : 'grid'))}}" 
                wx:if="{{item.images && item.images.length > 0}}">
            <image 
              wx:for="{{item.images}}" 
              wx:for-item="img"
              wx:key="*this"
              class="post-image" 
              src="{{img}}" 
              mode="aspectFill"
              data-urls="{{item.images}}"
              data-current="{{img}}"
              bindtap="previewImage"
            ></image>
          </view>
        </view>

        <!-- äº’åŠ¨åŒº -->
        <view class="post-footer">
          <view 
            class="action-btn {{item.isLiked ? 'liked' : ''}}" 
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="toggleLike"
          >
            <text class="action-icon">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            <text class="action-text">{{item.likesCount || 'ç‚¹èµ'}}</text>
          </view>
          <view 
            class="action-btn"
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="viewComments"
          >
            <text class="action-icon">ğŸ’¬</text>
            <text class="action-text">{{item.commentsCount || 'è¯„è®º'}}</text>
          </view>
          <view class="action-btn" bindtap="sharePost" data-id="{{item.id}}" data-content="{{item.content}}">
            <text class="action-icon">â†—ï¸</text>
            <text class="action-text">åˆ†äº«</text>
          </view>
        </view>

        <!-- è¯„è®ºé¢„è§ˆåŒºï¼ˆæœ€å¤šæ˜¾ç¤º2æ¡ï¼‰ -->
        <view class="comments-preview" wx:if="{{item.comments && item.comments.length > 0}}">
          <view class="preview-comment" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="id" wx:if="{{index < 2}}">
            <text class="comment-author">{{comment.author.nickname}}</text>
            <text class="comment-text">ï¼š{{comment.content}}</text>
          </view>
          <view class="view-all-comments" wx:if="{{item.commentsCount > 2}}" bindtap="viewComments" data-id="{{item.id}}">
            æŸ¥çœ‹å…¨éƒ¨ {{item.commentsCount}} æ¡è¯„è®º
          </view>
        </view>

        <!-- å¿«é€Ÿè¯„è®ºè¾“å…¥ -->
        <view class="quick-comment" wx:if="{{expandedCommentPostId === item.id}}">
          <input 
            class="quick-input" 
            placeholder="å†™è¯„è®º..." 
            value="{{quickCommentContent}}"
            bindinput="onQuickCommentInput"
            bindconfirm="submitQuickComment"
            data-id="{{item.id}}"
            data-index="{{index}}"
            focus="{{expandedCommentPostId === item.id}}"
          />
          <button class="quick-send-btn" bindtap="submitQuickComment" data-id="{{item.id}}" data-index="{{index}}">
            å‘é€
          </button>
        </view>
      </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="list-footer">
        <view class="loading-more" wx:if="{{isLoadingMore}}">
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
        </view>
        <text class="footer-text" wx:elif="{{hasMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
        <text class="footer-text" wx:else>â€” å·²ç»åˆ°åº•äº† â€”</text>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:else>
      <view class="empty-icon animate-float">ğŸ“¢</view>
      <text class="empty-title">è¿˜æ²¡æœ‰åŠ¨æ€</text>
      <text class="empty-desc">å¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€ï¼Œåˆ†äº«ä½ çš„å¿ƒæƒ…å§ï¼</text>
    </view>
  </view>

  <!-- FAB å‘å¸ƒæŒ‰é’® -->
  <view class="fab" bindtap="openPublishModal" wx:if="{{familyInfo}}">
    <text class="fab-icon">âœï¸</text>
  </view>

  <!-- å‘å¸ƒå¼¹çª— -->
  <view class="modal-overlay {{showPublishModal ? 'show' : ''}}" bindtap="closePublishModal">
    <view class="modal-container publish-modal" catchtap="preventClose">
      <!-- å¤´éƒ¨ -->
      <view class="modal-header">
        <text class="header-cancel" bindtap="closePublishModal">å–æ¶ˆ</text>
        <text class="header-title">å‘å¸ƒåŠ¨æ€</text>
        <button 
          class="header-publish {{(hasContent || selectedImages.length > 0) ? 'active' : ''}}" 
          bindtap="publishPost"
          disabled="{{(!hasContent && selectedImages.length === 0) || isPublishing}}"
        >
          {{isPublishing ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒ'}}
        </button>
      </view>
      
      <!-- å†…å®¹ç¼–è¾‘ -->
      <view class="modal-body">
        <textarea 
          class="content-editor" 
          placeholder="åˆ†äº«ä½ çš„å¿ƒæƒ…æˆ–æƒ³æ³•..."
          value="{{postContent}}"
          bindinput="onContentInput"
          maxlength="500"
          auto-focus
        ></textarea>
        <text class="content-count">{{postContent.length || 0}}/500</text>
        
        <!-- å›¾ç‰‡é¢„è§ˆåŒº -->
        <view class="images-section">
          <view class="selected-images">
            <!-- å·²é€‰å›¾ç‰‡ -->
            <view class="image-item" wx:for="{{selectedImages}}" wx:key="index">
              <image class="preview-image" src="{{item}}" mode="aspectFill" bindtap="previewSelectedImage" data-index="{{index}}"></image>
              <view class="remove-btn" catchtap="removeImage" data-index="{{index}}">
                <text>Ã—</text>
              </view>
            </view>
            
            <!-- æ·»åŠ å›¾ç‰‡æŒ‰é’® -->
            <view class="add-image-btn" wx:if="{{selectedImages.length < 9}}" bindtap="showImageSourceMenu">
              <text class="add-icon">+</text>
              <text class="add-text">{{selectedImages.length > 0 ? '' : 'æ·»åŠ å›¾ç‰‡'}}</text>
            </view>
          </view>
          <text class="images-tip" wx:if="{{selectedImages.length > 0}}">{{selectedImages.length}}/9 å¼ å›¾ç‰‡</text>
        </view>
      </view>
      
      <!-- é€‰é¡¹ -->
      <view class="modal-options">
        <view class="option-row" bindtap="toggleAnonymous">
          <view class="option-left">
            <text class="option-icon">{{isAnonymous ? 'ğŸ™ˆ' : 'ğŸ‘¤'}}</text>
            <view class="option-info">
              <text class="option-title">{{isAnonymous ? 'åŒ¿åå‘å¸ƒ' : 'å®åå‘å¸ƒ'}}</text>
              <text class="option-desc">{{isAnonymous ? 'å®¶äººçœ‹ä¸åˆ°ä½ çš„èº«ä»½' : 'æ˜¾ç¤ºä½ çš„å¤´åƒå’Œæ˜µç§°'}}</text>
            </view>
          </view>
          <view class="toggle-switch {{isAnonymous ? 'on' : ''}}">
            <view class="toggle-thumb"></view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å›¾ç‰‡æ¥æºé€‰æ‹©èœå• -->
  <view class="action-sheet-overlay {{showImageSourceSheet ? 'show' : ''}}" bindtap="hideImageSourceMenu">
    <view class="action-sheet image-source-sheet" catchtap="preventClose">
      <view class="sheet-title">é€‰æ‹©å›¾ç‰‡æ¥æº</view>
      <view class="sheet-item" bindtap="takePhoto">
        <text class="sheet-icon">ğŸ“·</text>
        <text class="sheet-text">æ‹ç…§</text>
      </view>
      <view class="sheet-item" bindtap="chooseFromAlbum">
        <text class="sheet-icon">ğŸ–¼ï¸</text>
        <text class="sheet-text">ä»ç›¸å†Œé€‰æ‹©</text>
      </view>
      <view class="sheet-item cancel" bindtap="hideImageSourceMenu">
        <text class="sheet-text">å–æ¶ˆ</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œèœå• -->
  <view class="action-sheet-overlay {{showActionSheet ? 'show' : ''}}" bindtap="hideActionSheet">
    <view class="action-sheet" catchtap="preventClose">
      <view class="sheet-item delete" bindtap="deleteCurrentPost">
        <text class="sheet-icon">ğŸ—‘ï¸</text>
        <text class="sheet-text">åˆ é™¤åŠ¨æ€</text>
      </view>
      <view class="sheet-item cancel" bindtap="hideActionSheet">
        <text class="sheet-text">å–æ¶ˆ</text>
      </view>
    </view>
  </view>
</view>
