<!--pages/moments/moments.wxml - 精美设计版 (支持图片上传)-->
<view class="moments-page">
  <!-- 渐变头部 -->
  <view class="moments-header">
    <view class="header-bg"></view>
    <view class="header-content">
      <text class="header-title">💬 家庭动态</text>
      <text class="header-subtitle">分享生活点滴，记录美好时光</text>
    </view>
  </view>

  <!-- 无家庭提示 -->
  <view class="empty-state" wx:if="{{!familyInfo}}">
    <view class="empty-icon animate-float">🏠</view>
    <text class="empty-title">请先加入家庭</text>
    <text class="empty-desc">加入家庭后，才能查看和发布动态哦</text>
  </view>

  <view class="moments-content" wx:else>
    <!-- 发布入口 -->
    <view class="publish-entry" bindtap="openPublishModal">
      <view class="publish-avatar-wrap">
        <image class="publish-avatar" src="{{userInfo.avatarUrl || '/assets/images/default-avatar.png'}}"></image>
      </view>
      <view class="publish-placeholder">
        <text>✏️ 分享一下今天的心情...</text>
      </view>
      <view class="publish-btn-icon">
        <text>📷</text>
      </view>
    </view>

    <!-- 动态列表 -->
    <view class="posts-list" wx:if="{{posts.length > 0}}">
      <view class="post-card" wx:for="{{posts}}" wx:key="id">
        <!-- 作者信息 -->
        <view class="post-header">
          <view class="post-author">
            <view class="author-avatar-wrap">
              <image 
                class="author-avatar" 
                src="{{item.isAnonymous ? '/assets/images/default-avatar.png' : (item.user.avatarUrl || item.user.avatar_url || '/assets/images/default-avatar.png')}}"
              ></image>
              <view class="anonymous-mask" wx:if="{{item.isAnonymous}}">
                <text>🙈</text>
              </view>
            </view>
            <view class="author-info">
              <text class="author-name">{{item.isAnonymous ? '匿名家人' : item.user.nickname}}</text>
              <text class="post-time">{{item.createdAtText}}</text>
            </view>
          </view>
          
          <!-- 更多操作 -->
          <view 
            class="post-more" 
            wx:if="{{item.userId === currentUserId}}"
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="showPostActions"
          >
            <text class="more-icon">•••</text>
          </view>
        </view>

        <!-- 内容 -->
        <view class="post-body">
          <text class="post-content">{{item.content}}</text>
          
          <!-- 图片网格 -->
          <view class="post-images {{item.images.length === 1 ? 'single' : (item.images.length === 2 ? 'double' : (item.images.length === 4 ? 'quad' : 'grid'))}}" 
                wx:if="{{item.images && item.images.length > 0}}">
            <image 
              wx:for="{{item.images}}" 
              wx:for-item="img"
              wx:key="*this"
              class="post-image" 
              src="{{img}}" 
              mode="aspectFill"
              data-urls="{{item.images}}"
              data-current="{{img}}"
              bindtap="previewImage"
            ></image>
          </view>
        </view>

        <!-- 互动区 -->
        <view class="post-footer">
          <view 
            class="action-btn {{item.isLiked ? 'liked' : ''}}" 
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="toggleLike"
          >
            <text class="action-icon">{{item.isLiked ? '❤️' : '🤍'}}</text>
            <text class="action-text">{{item.likesCount || '点赞'}}</text>
          </view>
          <view 
            class="action-btn"
            data-id="{{item.id}}"
            bindtap="viewComments"
          >
            <text class="action-icon">💬</text>
            <text class="action-text">{{item.commentsCount || '评论'}}</text>
          </view>
          <view class="action-btn" bindtap="sharePost" data-id="{{item.id}}">
            <text class="action-icon">↗️</text>
            <text class="action-text">分享</text>
          </view>
        </view>
      </view>

      <!-- 加载状态 -->
      <view class="list-footer">
        <view class="loading-more" wx:if="{{isLoadingMore}}">
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
        </view>
        <text class="footer-text" wx:elif="{{hasMore}}">上拉加载更多</text>
        <text class="footer-text" wx:else>— 已经到底了 —</text>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:else>
      <view class="empty-icon animate-float">📢</view>
      <text class="empty-title">还没有动态</text>
      <text class="empty-desc">快来发布第一条动态，分享你的心情吧！</text>
    </view>
  </view>

  <!-- FAB 发布按钮 -->
  <view class="fab" bindtap="openPublishModal" wx:if="{{familyInfo}}">
    <text class="fab-icon">✏️</text>
  </view>

  <!-- 发布弹窗 -->
  <view class="modal-overlay {{showPublishModal ? 'show' : ''}}" bindtap="closePublishModal">
    <view class="modal-container publish-modal" catchtap="preventClose">
      <!-- 头部 -->
      <view class="modal-header">
        <text class="header-cancel" bindtap="closePublishModal">取消</text>
        <text class="header-title">发布动态</text>
        <button 
          class="header-publish {{(hasContent || selectedImages.length > 0) ? 'active' : ''}}" 
          bindtap="publishPost"
          disabled="{{(!hasContent && selectedImages.length === 0) || isPublishing}}"
        >
          {{isPublishing ? '发布中...' : '发布'}}
        </button>
      </view>
      
      <!-- 内容编辑 -->
      <view class="modal-body">
        <textarea 
          class="content-editor" 
          placeholder="分享你的心情或想法..."
          value="{{postContent}}"
          bindinput="onContentInput"
          maxlength="500"
          auto-focus
        ></textarea>
        <text class="content-count">{{postContent.length || 0}}/500</text>
        
        <!-- 图片预览区 -->
        <view class="images-section">
          <view class="selected-images">
            <!-- 已选图片 -->
            <view class="image-item" wx:for="{{selectedImages}}" wx:key="index">
              <image class="preview-image" src="{{item}}" mode="aspectFill" bindtap="previewSelectedImage" data-index="{{index}}"></image>
              <view class="remove-btn" catchtap="removeImage" data-index="{{index}}">
                <text>×</text>
              </view>
            </view>
            
            <!-- 添加图片按钮 -->
            <view class="add-image-btn" wx:if="{{selectedImages.length < 9}}" bindtap="showImageSourceMenu">
              <text class="add-icon">+</text>
              <text class="add-text">{{selectedImages.length > 0 ? '' : '添加图片'}}</text>
            </view>
          </view>
          <text class="images-tip" wx:if="{{selectedImages.length > 0}}">{{selectedImages.length}}/9 张图片</text>
        </view>
      </view>
      
      <!-- 选项 -->
      <view class="modal-options">
        <view class="option-row" bindtap="toggleAnonymous">
          <view class="option-left">
            <text class="option-icon">{{isAnonymous ? '🙈' : '👤'}}</text>
            <view class="option-info">
              <text class="option-title">{{isAnonymous ? '匿名发布' : '实名发布'}}</text>
              <text class="option-desc">{{isAnonymous ? '家人看不到你的身份' : '显示你的头像和昵称'}}</text>
            </view>
          </view>
          <view class="toggle-switch {{isAnonymous ? 'on' : ''}}">
            <view class="toggle-thumb"></view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 图片来源选择菜单 -->
  <view class="action-sheet-overlay {{showImageSourceSheet ? 'show' : ''}}" bindtap="hideImageSourceMenu">
    <view class="action-sheet image-source-sheet" catchtap="preventClose">
      <view class="sheet-title">选择图片来源</view>
      <view class="sheet-item" bindtap="takePhoto">
        <text class="sheet-icon">📷</text>
        <text class="sheet-text">拍照</text>
      </view>
      <view class="sheet-item" bindtap="chooseFromAlbum">
        <text class="sheet-icon">🖼️</text>
        <text class="sheet-text">从相册选择</text>
      </view>
      <view class="sheet-item cancel" bindtap="hideImageSourceMenu">
        <text class="sheet-text">取消</text>
      </view>
    </view>
  </view>

  <!-- 操作菜单 -->
  <view class="action-sheet-overlay {{showActionSheet ? 'show' : ''}}" bindtap="hideActionSheet">
    <view class="action-sheet" catchtap="preventClose">
      <view class="sheet-item delete" bindtap="deleteCurrentPost">
        <text class="sheet-icon">🗑️</text>
        <text class="sheet-text">删除动态</text>
      </view>
      <view class="sheet-item cancel" bindtap="hideActionSheet">
        <text class="sheet-text">取消</text>
      </view>
    </view>
  </view>
</view>
