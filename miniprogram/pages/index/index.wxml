<!--pages/index/index.wxml-->
<view class="container index-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
  </view>

  <!-- å·²æœ‰å®¶åº­ -->
  <block wx:elif="{{hasFamily}}">
    <!-- æ¬¢è¿å¤´éƒ¨ -->
    <view class="header-section">
      <view class="welcome-info">
        <view class="welcome-text">
          <text class="greeting">{{userInfo.nickname || 'å®¶äºº'}}ï¼Œå¥½~</text>
          <text class="family-name">ğŸ  {{familyInfo.name}}</text>
        </view>
        <image 
          class="user-avatar avatar-medium" 
          src="{{userInfo.avatarUrl || '/assets/images/default-avatar.png'}}"
          mode="aspectFill"
          bindtap="goToFamily"
        ></image>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œ -->
    <view class="quick-actions card">
      <view class="quick-action-item" bindtap="goToRecordChore">
        <view class="action-icon">ğŸ§¹</view>
        <text class="action-text">è®°å½•å®¶åŠ¡</text>
      </view>
      <view class="quick-action-item" bindtap="goToPointsDetail">
        <view class="action-icon">ğŸ’°</view>
        <text class="action-text">æˆ‘çš„ç§¯åˆ†</text>
      </view>
      <view class="quick-action-item" bindtap="goToRewards">
        <view class="action-icon">ğŸ</view>
        <text class="action-text">å¥–åŠ±è®¾ç½®</text>
      </view>
      <view class="quick-action-item" bindtap="goToFamily">
        <view class="action-icon">ğŸ‘¥</view>
        <text class="action-text">å®¶åº­ç®¡ç†</text>
      </view>
    </view>

    <!-- ç§¯åˆ†æ¦‚è§ˆ -->
    <view class="points-overview card">
      <view class="card-header flex-between">
        <text class="card-title">ç§¯åˆ†æ¦‚è§ˆ</text>
        <text class="view-more text-primary" bindtap="goToPointsDetail">æŸ¥çœ‹è¯¦æƒ… ></text>
      </view>
      <view class="points-stats">
        <view class="points-item">
          <text class="points-value text-primary">{{pointsSummary.totalPoints || 0}}</text>
          <text class="points-label">ç´¯è®¡ç§¯åˆ†</text>
        </view>
        <view class="points-divider"></view>
        <view class="points-item">
          <text class="points-value text-success">{{pointsSummary.weekPoints || 0}}</text>
          <text class="points-label">æœ¬å‘¨è·å¾—</text>
        </view>
        <view class="points-divider"></view>
        <view class="points-item">
          <text class="points-value text-warning">{{pointsSummary.rank || '-'}}</text>
          <text class="points-label">å®¶åº­æ’å</text>
        </view>
      </view>
    </view>

    <!-- å®¶åº­æ’è¡Œæ¦œ -->
    <view class="ranking-section card" wx:if="{{familyRanking.length > 0}}">
      <view class="card-header flex-between">
        <text class="card-title">ğŸ† æœ¬å‘¨æ’è¡Œ</text>
      </view>
      <view class="ranking-list">
        <view class="ranking-item" wx:for="{{familyRanking}}" wx:key="userId">
          <view class="ranking-position {{index < 3 ? 'top-three' : ''}}">
            <text wx:if="{{index === 0}}">ğŸ¥‡</text>
            <text wx:elif="{{index === 1}}">ğŸ¥ˆ</text>
            <text wx:elif="{{index === 2}}">ğŸ¥‰</text>
            <text wx:else>{{index + 1}}</text>
          </view>
          <image class="ranking-avatar avatar-small" src="{{item.avatarUrl || '/assets/images/default-avatar.png'}}"></image>
          <text class="ranking-name">{{item.nickname}}</text>
          <text class="ranking-points">{{item.points}}åˆ†</text>
        </view>
      </view>
    </view>

    <!-- æœ€æ–°åŠ¨æ€ -->
    <view class="moments-section card" wx:if="{{latestMoments.length > 0}}">
      <view class="card-header flex-between">
        <text class="card-title">ğŸ“¢ å®¶åº­åŠ¨æ€</text>
        <text class="view-more text-primary" bindtap="goToMoments">æŸ¥çœ‹æ›´å¤š ></text>
      </view>
      <view class="moments-list">
        <view class="moment-item" wx:for="{{latestMoments}}" wx:key="id">
          <view class="moment-header">
            <image class="moment-avatar avatar-small" src="{{item.isAnonymous ? '/assets/images/default-avatar.png' : item.user.avatarUrl}}"></image>
            <view class="moment-info">
              <text class="moment-author">{{item.isAnonymous ? 'åŒ¿å' : item.user.nickname}}</text>
              <text class="moment-time text-muted">{{item.createdAtText}}</text>
            </view>
          </view>
          <view class="moment-content">{{item.content}}</view>
        </view>
      </view>
    </view>
  </block>

  <!-- æœªåŠ å…¥å®¶åº­ -->
  <block wx:else>
    <view class="no-family-container">
      <view class="no-family-icon">ğŸ </view>
      <view class="no-family-title">è¿˜æ²¡æœ‰åŠ å…¥å®¶åº­</view>
      <view class="no-family-desc">åˆ›å»ºæˆ–åŠ å…¥ä¸€ä¸ªå®¶åº­ï¼Œå¼€å§‹è®°å½•å®¶åŠ¡å§ï¼</view>
      
      <view class="family-actions">
        <button class="btn-primary btn-block" bindtap="goToCreateFamily">åˆ›å»ºæ–°å®¶åº­</button>
        <button class="btn-secondary btn-block mt-20" bindtap="goToJoinFamily">åŠ å…¥å·²æœ‰å®¶åº­</button>
      </view>
    </view>
  </block>
</view>
