<!--pages/index/index.wxml - ç²¾ç¾è®¾è®¡ç‰ˆ-->
<view class="page-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-wrapper">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- å·²æœ‰å®¶åº­ -->
  <block wx:elif="{{hasFamily}}">
    <!-- æ¸å˜å¤´éƒ¨ -->
    <view class="home-header">
      <view class="header-bg"></view>
      <view class="header-content">
        <view class="welcome-row">
          <view class="welcome-text">
            <text class="greeting">ä½ å¥½ï¼Œ{{userInfo.nickname || 'å®¶äºº'}} ğŸ‘‹</text>
            <view class="family-badge">
              <text class="family-icon">ğŸ </text>
              <text class="family-name">{{familyInfo.name}}</text>
            </view>
          </view>
          <view class="avatar-wrapper" bindtap="goToFamily">
            <image 
              class="user-avatar" 
              src="{{userInfo.avatarUrl || '/assets/images/default-avatar.png'}}"
              mode="aspectFill"
            ></image>
            <view class="avatar-ring"></view>
          </view>
        </view>
        
        <!-- ç»Ÿè®¡æ•°æ®å¡ç‰‡ -->
        <view class="stats-card">
          <view class="stat-item">
            <text class="stat-value">{{pointsSummary.totalPoints || 0}}</text>
            <text class="stat-label">æ€»ç§¯åˆ†</text>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item">
            <text class="stat-value stat-success">{{pointsSummary.weekPoints || 0}}</text>
            <text class="stat-label">æœ¬å‘¨è·å¾—</text>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item">
            <text class="stat-value stat-warning">{{pointsSummary.rank || '-'}}</text>
            <text class="stat-label">æ’å</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <view class="home-content">
      <!-- å¿«æ·æ“ä½œ -->
      <view class="section-title">
        <text class="title-icon">âš¡</text>
        <text class="title-text">å¿«æ·æ“ä½œ</text>
      </view>
      <view class="quick-actions">
        <view class="action-card" bindtap="goToRecordChore">
          <view class="action-icon-wrap action-chore">
            <text class="action-emoji">ğŸ§¹</text>
          </view>
          <text class="action-name">è®°å½•å®¶åŠ¡</text>
          <text class="action-desc">è®°å½•å®Œæˆçš„å®¶åŠ¡</text>
        </view>
        <view class="action-card" bindtap="goToSavings">
          <view class="action-icon-wrap action-savings">
            <text class="action-emoji">ğŸ¦</text>
          </view>
          <text class="action-name">æˆ‘çš„å­˜æ¬¾</text>
          <text class="action-desc">å¤åˆ©è®©é’±ç”Ÿé’±</text>
        </view>
        <view class="action-card" bindtap="goToRewards">
          <view class="action-icon-wrap action-reward">
            <text class="action-emoji">ğŸ</text>
          </view>
          <text class="action-name">å¥–åŠ±è®¾ç½®</text>
          <text class="action-desc">ç®¡ç†å®¶åŠ¡å¥–åŠ±</text>
        </view>
        <view class="action-card" bindtap="goToFamily">
          <view class="action-icon-wrap action-family">
            <text class="action-emoji">ğŸ‘¥</text>
          </view>
          <text class="action-name">å®¶åº­ç®¡ç†</text>
          <text class="action-desc">ç®¡ç†å®¶åº­æˆå‘˜</text>
        </view>
      </view>

      <!-- å®¶åº­æ’è¡Œæ¦œ -->
      <view class="section-title" wx:if="{{familyRanking.length > 0}}">
        <text class="title-icon">ğŸ†</text>
        <text class="title-text">æœ¬å‘¨æ’è¡Œ</text>
      </view>
      <view class="ranking-card" wx:if="{{familyRanking.length > 0}}">
        <view class="ranking-item" wx:for="{{familyRanking}}" wx:key="userId">
          <view class="rank-badge rank-{{index + 1}}">
            <text wx:if="{{index === 0}}">ğŸ¥‡</text>
            <text wx:elif="{{index === 1}}">ğŸ¥ˆ</text>
            <text wx:elif="{{index === 2}}">ğŸ¥‰</text>
            <text wx:else class="rank-number">{{index + 1}}</text>
          </view>
          <image 
            class="rank-avatar" 
            src="{{item.avatarUrl || '/assets/images/default-avatar.png'}}"
            mode="aspectFill"
          ></image>
          <text class="rank-name">{{item.nickname}}</text>
          <view class="rank-points">
            <text class="points-num">{{item.points}}</text>
            <text class="points-unit">åˆ†</text>
          </view>
        </view>
        <view class="ranking-empty" wx:if="{{familyRanking.length === 0}}">
          <text>æœ¬å‘¨è¿˜æ²¡æœ‰äººè®°å½•å®¶åŠ¡å“¦</text>
        </view>
      </view>

      <!-- æœ€æ–°åŠ¨æ€ -->
      <view class="section-title" wx:if="{{latestMoments.length > 0}}">
        <text class="title-icon">ğŸ“¢</text>
        <text class="title-text">å®¶åº­åŠ¨æ€</text>
        <text class="title-more" bindtap="goToMoments">æŸ¥çœ‹æ›´å¤š ></text>
      </view>
      <view class="moments-card" wx:if="{{latestMoments.length > 0}}">
        <view class="moment-item" wx:for="{{latestMoments}}" wx:key="id" bindtap="goToMomentDetail" data-id="{{item.id}}">
          <image 
            class="moment-avatar" 
            src="{{item.isAnonymous ? '/assets/images/default-avatar.png' : item.user.avatarUrl}}"
            mode="aspectFill"
          ></image>
          <view class="moment-content">
            <view class="moment-header">
              <text class="moment-author">{{item.isAnonymous ? 'åŒ¿åç”¨æˆ·' : item.user.nickname}}</text>
              <text class="moment-time">{{item.createdAtText}}</text>
            </view>
            <text class="moment-text">{{item.content}}</text>
          </view>
        </view>
      </view>
    </view>
  </block>

  <!-- æœªåŠ å…¥å®¶åº­ -->
  <block wx:else>
    <view class="no-family-page">
      <view class="no-family-bg"></view>
      <view class="no-family-content">
        <view class="no-family-icon animate-float">
          <text class="icon-emoji">ğŸ </text>
          <view class="icon-glow"></view>
        </view>
        <text class="no-family-title">è¿˜æ²¡æœ‰åŠ å…¥å®¶åº­</text>
        <text class="no-family-desc">åˆ›å»ºæˆ–åŠ å…¥ä¸€ä¸ªå®¶åº­ï¼Œå’Œå®¶äººä¸€èµ·è®°å½•å®¶åŠ¡å§ï¼</text>
        
        <view class="family-actions">
          <button class="action-btn btn-create" bindtap="goToCreateFamily">
            <text class="btn-icon">âœ¨</text>
            <text class="btn-label">åˆ›å»ºæ–°å®¶åº­</text>
          </button>
          <button class="action-btn btn-join" bindtap="goToJoinFamily">
            <text class="btn-icon">ğŸ”—</text>
            <text class="btn-label">åŠ å…¥å·²æœ‰å®¶åº­</text>
          </button>
        </view>
      </view>
    </view>
  </block>
</view>
