<!--pages/profile/points.wxml - 3Dæç®€ç§‘æŠ€ç‰ˆ-->
<view class="page-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="hero-section">
    <view class="hero-bg-glow"></view>
    <view class="hero-content page-fade-in">
      <view class="hero-title">ç§¯åˆ†æ˜ç»†</view>
      <view class="hero-subtitle">Your Points & Rewards</view>
    </view>
  </view>

  <!-- ç§¯åˆ†æ¦‚è§ˆå¡ç‰‡ (Glassmorphism Card) -->
  <view class="glass-card summary-card success-pop">
    <view class="summary-main">
      <text class="total-label">å¯ç”¨ç§¯åˆ†</text>
      <text class="total-value">{{summary.availablePoints || 0}}</text>
      <view class="redeem-btn btn-active-feedback" bindtap="showRedeemApplyModal" wx:if="{{summary.availablePoints > 0}}">ç”³è¯·å…‘ç°</view>
    </view>
    <view class="stat-row">
      <view class="stat-item">
        <text class="stat-label">æœ¬æœˆè·å¾—</text>
        <text class="stat-value">+{{summary.thisMonth || 0}}</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-label">ç´¯è®¡å…‘ç°</text>
        <text class="stat-value">-{{summary.redeemedTotal || 0}}</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-label">å®¶åº­æ’å</text>
        <text class="stat-value">{{summary.rank || '-'}}</text>
      </view>
    </view>
  </view>

  <!-- ç®¡ç†å‘˜å¾…å®¡æ ¸æç¤º -->
  <view class="glass-card notice-card" wx:if="{{isAdmin && pendingRedeemCount > 0}}" bindtap="goToRedeemReview">
    <view class="notice-content">
      <text class="notice-icon">ğŸ””</text>
      <text class="notice-text">{{pendingRedeemCount}} ä¸ªå…‘ç°ç”³è¯·å¾…å®¡æ ¸</text>
    </view>
    <text class="arrow">â€º</text>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <view class="section-header">
    <text class="section-title">æ”¶æ”¯æ˜ç»†</text>
    <view class="filter-tabs">
      <view class="filter-item {{filterType === 'all' ? 'active' : ''}}" data-type="all" bindtap="switchFilter">å…¨éƒ¨</view>
      <view class="filter-item {{filterType === 'earn' ? 'active' : ''}}" data-type="earn" bindtap="switchFilter">è·å¾—</view>
      <view class="filter-item {{filterType === 'redeem' ? 'active' : ''}}" data-type="redeem" bindtap="switchFilter">å…‘ç°</view>
    </view>
  </view>

  <!-- ç§¯åˆ†åˆ—è¡¨ -->
  <view class="section-header">
    <text class="section-title">æ”¶æ”¯æ˜ç»†</text>
    <view class="history-link" bindtap="viewAllRedeemRequests">å…‘ç°è®°å½• â€º</view>
  </view>
  <view class="transactions-list">
    <view class="transaction-item glass-card" wx:for="{{transactions}}" wx:key="id">
      <view class="trans-icon">{{item.type === 'earn' ? 'ğŸ“ˆ' : (item.type === 'redeem' ? 'ğŸ' : 'ğŸ“‰')}}</view>
      <view class="trans-info">
        <text class="trans-title">{{item.description}}</text>
        <text class="trans-time">{{item.createdAtText}}</text>
      </view>
      <view class="trans-points {{item.type === 'earn' ? 'positive' : 'negative'}}">
        {{item.type === 'earn' ? '+' : '-'}}{{item.points}}
      </view>
    </view>
    
    <view class="empty-tip" wx:if="{{transactions.length === 0}}">æš‚æ— ç§¯åˆ†è®°å½•</view>
  </view>

  <!-- ç”³è¯·å…‘ç°å¼¹çª— -->
  <view class="modal-mask {{showRedeemApplyModal ? 'show' : ''}}" bindtap="closeRedeemApplyModal">
    <view class="modal-content glass-card {{showRedeemApplyModal ? 'show' : ''}}" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">ç”³è¯·å…‘ç°ç§¯åˆ†</text>
        <view class="close-btn" bindtap="closeRedeemApplyModal">Ã—</view>
      </view>
      
      <scroll-view scroll-y class="modal-body">
        <view class="points-info-box">
          <view class="info-row">
            <text class="info-label">å¯ç”¨ç§¯åˆ†</text>
            <text class="info-value">{{summary.availablePoints - pendingApplyPoints}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ç§¯åˆ†ä»·å€¼</text>
            <text class="info-value">1 ç§¯åˆ† = {{summary.pointsValue}} å…ƒ</text>
          </view>
        </view>

        <view class="form-item">
          <text class="form-label">å…‘ç°ç§¯åˆ†</text>
          <view class="input-wrap">
            <input 
              class="form-input" 
              type="number" 
              placeholder="è¾“å…¥è¦å…‘ç°çš„ç§¯åˆ†æ•°é‡" 
              value="{{applyPoints}}" 
              bindinput="onApplyPointsInput" 
            />
            <text class="all-link" bindtap="setFullApplyAmount">å…¨éƒ¨</text>
          </view>
          <text class="amount-tip">é¢„è®¡å¯å¾—é‡‘é¢ï¼š<text class="highlight">Â¥{{applyAmount}}</text></text>
        </view>

        <view class="quick-amounts">
          <view class="quick-item" data-amount="100" bindtap="setQuickApplyAmount">100</view>
          <view class="quick-item" data-amount="200" bindtap="setQuickApplyAmount">200</view>
          <view class="quick-item" data-amount="500" bindtap="setQuickApplyAmount">500</view>
          <view class="quick-item" data-amount="1000" bindtap="setQuickApplyAmount">1000</view>
        </view>

        <view class="form-item">
          <text class="form-label">å¤‡æ³¨ (å¯é€‰)</text>
          <textarea class="form-textarea" placeholder="å¡«å†™ç”¨é€”æˆ–å…¶ä»–è¯´æ˜..." value="{{applyRemark}}" bindinput="onApplyRemarkInput" />
        </view>
      </scroll-view>

      <view class="modal-footer">
        <view class="primary-btn submit-btn btn-active-feedback {{isApplying ? 'disabled' : ''}}" bindtap="submitRedeemApply">
          <text>{{isApplying ? 'æäº¤ä¸­...' : 'ç¡®è®¤ç”³è¯·'}}</text>
          <view class="btn-glow"></view>
        </view>
      </view>
    </view>
  </view>

  <view class="safe-bottom"></view>
</view>
