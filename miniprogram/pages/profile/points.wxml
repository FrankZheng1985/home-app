<!--pages/profile/points.wxml - ç§¯åˆ†ç»Ÿè®¡é¡µé¢-->
<view class="points-page">
  <!-- ç§¯åˆ†æ¦‚è§ˆå¡ç‰‡ -->
  <view class="summary-card">
    <view class="summary-bg"></view>
    <view class="summary-content">
      <view class="summary-main">
        <text class="total-label">å¯ç”¨ç§¯åˆ†</text>
        <text class="total-points">{{summary.availablePoints || 0}}</text>
        <!-- ç”³è¯·å…‘ç°æŒ‰é’® -->
        <button class="redeem-apply-btn" bindtap="showRedeemApplyModal" wx:if="{{summary.availablePoints > 0}}">
          ç”³è¯·å…‘ç°
        </button>
      </view>
      <view class="summary-stats">
        <view class="stat-item">
          <text class="stat-value">+{{summary.thisMonth || 0}}</text>
          <text class="stat-label">æœ¬æœˆè·å¾—</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value">-{{summary.redeemedTotal || 0}}</text>
          <text class="stat-label">ç´¯è®¡å…‘ç°</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value">ç¬¬{{summary.rank || '-'}}å</text>
          <text class="stat-label">å®¶åº­æ’å</text>
        </view>
      </view>
    </view>
    <view class="coin-icon">ğŸ’°</view>
  </view>

  <!-- å¾…å®¡æ ¸æç¤ºï¼ˆç®¡ç†å‘˜å¯è§ï¼‰ -->
  <view class="pending-notice" wx:if="{{isAdmin && pendingRedeemCount > 0}}" bindtap="goToRedeemReview">
    <text class="notice-icon">ğŸ””</text>
    <text class="notice-text">æœ‰ {{pendingRedeemCount}} ä¸ªå…‘ç°ç”³è¯·å¾…å®¡æ ¸</text>
    <text class="notice-arrow">â€º</text>
  </view>

  <!-- æˆ‘çš„å…‘ç°ç”³è¯· -->
  <view class="section-card" wx:if="{{myRedeemRequests.length > 0}}">
    <view class="section-header-row">
      <text class="section-title">ğŸ“ æˆ‘çš„å…‘ç°ç”³è¯·</text>
      <view class="view-all" bindtap="viewAllRedeemRequests">
        <text>æŸ¥çœ‹å…¨éƒ¨</text>
        <text class="arrow">â€º</text>
      </view>
    </view>
    <view class="redeem-requests-list">
      <view class="redeem-request-item" wx:for="{{myRedeemRequests}}" wx:key="id">
        <view class="request-left">
          <view class="request-points">{{item.points}} ç§¯åˆ†</view>
          <view class="request-amount">â‰ˆ Â¥{{item.amount}}</view>
        </view>
        <view class="request-right">
          <view class="request-status {{item.status}}">
            {{item.status === 'pending' ? 'å¾…å®¡æ ¸' : (item.status === 'approved' ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»')}}
          </view>
          <view class="request-time">{{item.createdAtText}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- æœˆåº¦ç»Ÿè®¡ -->
  <view class="section-card">
    <view class="section-header-row">
      <text class="section-title">ğŸ“Š æœˆåº¦ç»Ÿè®¡</text>
      <!-- æœˆä»½é€‰æ‹©å™¨ -->
      <picker mode="date" fields="month" value="{{selectedMonth}}" bindchange="onMonthChange">
        <view class="month-picker">
          <text class="month-text">{{selectedMonthDisplay}}</text>
          <text class="month-arrow">â–¼</text>
        </view>
      </picker>
    </view>
    
    <!-- æœˆåº¦æ•°æ® -->
    <view class="month-stats">
      <view class="month-stat-item earned">
        <view class="stat-icon">ğŸ“ˆ</view>
        <view class="stat-detail">
          <text class="stat-number">+{{monthStats.earned || 0}}</text>
          <text class="stat-desc">æœ¬æœˆè·å¾—</text>
        </view>
      </view>
      <view class="month-stat-item redeemed">
        <view class="stat-icon">ğŸ</view>
        <view class="stat-detail">
          <text class="stat-number">-{{monthStats.redeemed || 0}}</text>
          <text class="stat-desc">æœ¬æœˆå…‘ç°</text>
        </view>
      </view>
      <view class="month-stat-item balance">
        <view class="stat-icon">ğŸ’</view>
        <view class="stat-detail">
          <text class="stat-number">{{monthStats.balance || 0}}</text>
          <text class="stat-desc">æœˆæœ«ä½™é¢</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç»“ç®—åŠŸèƒ½ï¼ˆç®¡ç†å‘˜å¯è§ï¼‰ -->
  <view class="section-card" wx:if="{{isAdmin}}">
    <view class="section-header-row">
      <text class="section-title">ğŸ’µ ç§¯åˆ†ç»“ç®—</text>
    </view>
    <view class="settlement-info">
      <text class="settlement-desc">å°†ç§¯åˆ†å…‘ç°ç»™å®¶åº­æˆå‘˜åï¼Œæ‰£é™¤ç›¸åº”ç§¯åˆ†ã€‚å»ºè®®æ¯æœˆåº•ç»“ç®—ä¸€æ¬¡ã€‚</text>
    </view>
    
    <!-- æˆå‘˜åˆ—è¡¨ -->
    <view class="member-settlement-list">
      <view class="member-settlement-item" wx:for="{{familyMembers}}" wx:key="id">
        <view class="member-info-row">
          <image class="member-avatar" src="{{item.user.avatarUrl || '/assets/images/default-avatar.png'}}"></image>
          <view class="member-detail">
            <text class="member-name">{{item.user.nickname}}</text>
            <text class="member-points">å¯ç”¨ç§¯åˆ†ï¼š{{item.availablePoints || 0}}</text>
          </view>
        </view>
        <button 
          class="settle-btn" 
          data-member="{{item}}"
          bindtap="showSettleModal"
          disabled="{{!item.availablePoints || item.availablePoints <= 0}}"
        >ç»“ç®—</button>
      </view>
    </view>
  </view>

  <!-- ç§¯åˆ†æ˜ç»† -->
  <view class="section-card">
    <view class="section-header-row">
      <text class="section-title">ğŸ“‹ ç§¯åˆ†æ˜ç»†</text>
      <view class="filter-tabs">
        <view class="filter-tab {{filterType === 'all' ? 'active' : ''}}" 
              data-type="all" bindtap="switchFilter">å…¨éƒ¨</view>
        <view class="filter-tab {{filterType === 'earn' ? 'active' : ''}}" 
              data-type="earn" bindtap="switchFilter">è·å¾—</view>
        <view class="filter-tab {{filterType === 'redeem' ? 'active' : ''}}" 
              data-type="redeem" bindtap="switchFilter">å…‘ç°</view>
      </view>
    </view>

    <view class="transactions-list" wx:if="{{transactions.length > 0}}">
      <view class="transaction-card" wx:for="{{transactions}}" wx:key="id">
        <view class="transaction-icon {{item.type === 'earn' ? 'earn' : (item.type === 'redeem' ? 'redeem' : 'spend')}}">
          <text>{{item.type === 'earn' ? 'ğŸ“ˆ' : (item.type === 'redeem' ? 'ğŸ' : 'ğŸ“‰')}}</text>
        </view>
        <view class="transaction-info">
          <text class="transaction-title">{{item.description}}</text>
          <text class="transaction-time">{{item.createdAtText}}</text>
        </view>
        <text class="transaction-points {{item.type === 'earn' ? 'positive' : 'negative'}}">
          {{item.type === 'earn' ? '+' : '-'}}{{item.points}}
        </text>
      </view>
    </view>

    <view class="empty-state" wx:else>
      <view class="empty-icon animate-float">ğŸ“Š</view>
      <view class="empty-title">æš‚æ— ç§¯åˆ†è®°å½•</view>
      <view class="empty-desc">å®Œæˆå®¶åŠ¡å³å¯è·å¾—ç§¯åˆ†å“¦</view>
    </view>

    <view class="load-more" wx:if="{{hasMore && transactions.length > 0}}">
      <text>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>
    <view class="no-more" wx:if="{{!hasMore && transactions.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </view>

  <!-- ç»“ç®—å¼¹çª—ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰ -->
  <view class="modal-overlay {{showSettleModal ? 'show' : ''}}" bindtap="closeSettleModal">
    <view class="modal-container" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">ğŸ’µ ç§¯åˆ†ç»“ç®—</text>
        <view class="modal-close" bindtap="closeSettleModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="settle-member-info" wx:if="{{settleMember}}">
          <image class="settle-avatar" src="{{settleMember.user.avatarUrl || '/assets/images/default-avatar.png'}}"></image>
          <text class="settle-name">{{settleMember.user.nickname}}</text>
          <text class="settle-available">å¯ç”¨ç§¯åˆ†ï¼š{{settleMember.availablePoints || 0}}</text>
        </view>
        
        <view class="settle-form">
          <view class="form-label">ç»“ç®—ç§¯åˆ†</view>
          <input 
            class="settle-input" 
            type="number" 
            placeholder="è¯·è¾“å…¥è¦ç»“ç®—çš„ç§¯åˆ†æ•°é‡"
            value="{{settleAmount}}"
            bindinput="onSettleAmountInput"
          />
          
          <view class="quick-amounts">
            <view class="quick-btn" data-amount="100" bindtap="setQuickAmount">100</view>
            <view class="quick-btn" data-amount="500" bindtap="setQuickAmount">500</view>
            <view class="quick-btn" data-amount="1000" bindtap="setQuickAmount">1000</view>
            <view class="quick-btn full" bindtap="setFullAmount">å…¨éƒ¨</view>
          </view>
          
          <view class="form-label">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</view>
          <input 
            class="settle-input" 
            placeholder="å¦‚ï¼š2024å¹´1æœˆä»½ç§¯åˆ†ç»“ç®—"
            value="{{settleRemark}}"
            bindinput="onSettleRemarkInput"
          />
        </view>
      </view>
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeSettleModal">å–æ¶ˆ</button>
        <button 
          class="confirm-btn" 
          bindtap="confirmSettle"
          disabled="{{!settleAmount || settleAmount <= 0 || isSettling}}"
        >
          {{isSettling ? 'å¤„ç†ä¸­...' : 'ç¡®è®¤ç»“ç®—'}}
        </button>
      </view>
    </view>
  </view>

  <!-- ç”³è¯·å…‘ç°å¼¹çª—ï¼ˆç”¨æˆ·ç”¨ï¼‰ -->
  <view class="modal-overlay {{showRedeemApplyModal ? 'show' : ''}}" bindtap="closeRedeemApplyModal">
    <view class="modal-container" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">ğŸ ç”³è¯·å…‘ç°</text>
        <view class="modal-close" bindtap="closeRedeemApplyModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="apply-info">
          <view class="apply-available">
            <text class="label">å¯å…‘ç°ç§¯åˆ†</text>
            <text class="value">{{summary.availablePoints - pendingApplyPoints}}</text>
          </view>
          <view class="apply-rate">
            <text class="label">ç§¯åˆ†ä»·å€¼</text>
            <text class="value">{{summary.pointsValue || 0.5}} å…ƒ/ç§¯åˆ†</text>
          </view>
        </view>
        
        <view class="settle-form">
          <view class="form-label">å…‘ç°ç§¯åˆ†</view>
          <input 
            class="settle-input" 
            type="number" 
            placeholder="è¯·è¾“å…¥è¦å…‘ç°çš„ç§¯åˆ†æ•°é‡"
            value="{{applyPoints}}"
            bindinput="onApplyPointsInput"
          />
          
          <view class="apply-amount-preview" wx:if="{{applyPoints > 0}}">
            é¢„è®¡å¯å…‘ç°é‡‘é¢ï¼š<text class="amount">Â¥{{applyAmount}}</text>
          </view>
          
          <view class="quick-amounts">
            <view class="quick-btn" data-amount="100" bindtap="setQuickApplyAmount">100</view>
            <view class="quick-btn" data-amount="500" bindtap="setQuickApplyAmount">500</view>
            <view class="quick-btn" data-amount="1000" bindtap="setQuickApplyAmount">1000</view>
            <view class="quick-btn full" bindtap="setFullApplyAmount">å…¨éƒ¨</view>
          </view>
          
          <view class="form-label">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</view>
          <input 
            class="settle-input" 
            placeholder="å¦‚ï¼šç”³è¯·å…‘ç°æœ¬æœˆç§¯åˆ†"
            value="{{applyRemark}}"
            bindinput="onApplyRemarkInput"
          />
        </view>
        
        <view class="apply-tips">
          <text class="tip-icon">ğŸ’¡</text>
          <text class="tip-text">æäº¤ç”³è¯·åï¼Œå®¶é•¿å®¡æ ¸é€šè¿‡åä¼šçº¿ä¸‹æ”¯ä»˜ç°é‡‘ç»™ä½ </text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeRedeemApplyModal">å–æ¶ˆ</button>
        <button 
          class="confirm-btn" 
          bindtap="submitRedeemApply"
          disabled="{{!applyPoints || applyPoints <= 0 || isApplying}}"
        >
          {{isApplying ? 'æäº¤ä¸­...' : 'æäº¤ç”³è¯·'}}
        </button>
      </view>
    </view>
  </view>
</view>
