<!--pages/savings/savings.wxml - 3Dæç®€ç§‘æŠ€ç‰ˆ-->
<wxs src="./savings.wxs" module="tools" />
<view class="page-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="hero-section" style="padding-top: {{statusBarHeight + 10}}px;">
    <view class="hero-bg-glow"></view>
    <view class="hero-content page-fade-in">
      <view class="back-row">
        <view class="back-btn btn-active-feedback" bindtap="goBack">â†</view>
        <view class="header-actions" wx:if="{{isCreator}}">
          <view bindtap="showMemberManage" class="action-icon btn-active-feedback">ğŸ‘¥</view>
          <view bindtap="showRateSetting" class="action-icon btn-active-feedback">âš™ï¸</view>
        </view>
      </view>
      <view class="hero-title">æˆ‘çš„å­˜æ¬¾</view>
      <view class="hero-subtitle">Compound Interest Magic</view>
    </view>
  </view>

  <!-- ç®¡ç†å‘˜ Tab åˆ‡æ¢ -->
  <view class="tabs-wrapper" wx:if="{{isAdmin}}">
    <view class="glass-card tabs tabs-2">
      <view class="tab-item {{activeTab === 'overview' ? 'active' : ''}}" data-tab="overview" bindtap="switchTab">æ¦‚è§ˆ</view>
      <view class="tab-item {{activeTab === 'requests' ? 'active' : ''}}" data-tab="requests" bindtap="switchTab">
        å®¡æ ¸
        <view class="pending-badge-mini" wx:if="{{pendingCount > 0}}">{{pendingCount}}</view>
      </view>
      <view class="tab-indicator {{activeTab === 'requests' ? 'pos-2' : ''}}"></view>
    </view>
  </view>

  <!-- è´¦æˆ·æ¦‚è§ˆå†…å®¹ -->
  <view class="tab-content" wx:if="{{activeTab === 'overview'}}">
    <!-- æ ¸å¿ƒä½™é¢å¡ç‰‡ -->
    <view class="glass-card balance-card success-pop">
      <text class="balance-label">è´¦æˆ·ä½™é¢</text>
      <view class="balance-value">
        <text class="currency">Â¥</text>
        <text class="amount">{{tools.formatMoney(account.balance)}}</text>
      </view>
      <view class="stat-row">
        <view class="stat-item">
          <text class="stat-label">å¹´åˆ©ç‡</text>
          <text class="stat-value highlight">{{tools.formatPercent(account.annualRate)}}%</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-label">ç´¯è®¡åˆ©æ¯</text>
          <text class="stat-value">Â¥{{tools.formatMoney(account.totalInterest)}}</text>
        </view>
      </view>
    </view>

    <!-- å¾…ç»“ç®—åˆ©æ¯ -->
    <view class="glass-card interest-card" wx:if="{{account.pendingInterest > 0}}">
      <view class="interest-info">
        <view>
          <text class="interest-title">å¾…ç»“ç®—åˆ©æ¯</text>
          <view class="interest-value">+Â¥{{displayedInterest}}</view>
        </view>
        <view class="settle-btn btn-active-feedback" bindtap="settleInterest">ç»“ç®—</view>
      </view>
      <text class="interest-tip">ğŸ’¡ ç»“ç®—ååˆ©æ¯å°†åŠ å…¥æœ¬é‡‘äº§ç”Ÿå¤åˆ©</text>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-row">
      <view class="primary-btn btn-active-feedback" bindtap="showDepositRequest" wx:if="{{!isAdmin}}">
        <text>ç”³è¯·å­˜æ¬¾</text>
      </view>
      <block wx:if="{{isAdmin}}">
        <view class="primary-btn btn-active-feedback" bindtap="showDeposit">
          <text>å­˜æ¬¾</text>
        </view>
        <view class="secondary-btn btn-active-feedback" bindtap="showWithdraw">
          <text>å–æ¬¾</text>
        </view>
      </block>
    </view>

    <!-- äº¤æ˜“è®°å½• -->
    <view class="section-title">äº¤æ˜“è®°å½•</view>
    <view class="transaction-list">
      <view class="transaction-item glass-card" wx:for="{{transactions}}" wx:key="id">
        <view class="trans-icon">{{item.type === 'deposit' ? 'ğŸ“¥' : item.type === 'withdraw' ? 'ğŸ“¤' : 'âœ¨'}}</view>
        <view class="trans-info">
          <text class="trans-desc">{{item.description || (item.type === 'deposit' ? 'å­˜æ¬¾' : item.type === 'withdraw' ? 'å–æ¬¾' : 'åˆ©æ¯')}}</text>
          <text class="trans-time">{{item.createdAt}}</text>
        </view>
        <view class="trans-amount {{item.type === 'withdraw' ? 'negative' : 'positive'}}">
          {{item.type === 'withdraw' ? '-' : '+'}}Â¥{{tools.formatMoney(item.amount)}}
        </view>
      </view>
      <view class="empty-tip" wx:if="{{transactions.length === 0}}">æš‚æ— äº¤æ˜“è®°å½•</view>
    </view>
  </view>

  <!-- å®¡æ ¸åˆ—è¡¨å†…å®¹ -->
  <view class="tab-content" wx:if="{{activeTab === 'requests' && isAdmin}}">
    <view class="request-list">
      <view class="request-item glass-card success-pop" wx:for="{{requests}}" wx:key="id">
        <view class="request-header">
          <image class="user-avatar" src="{{item.userAvatar || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
          <view class="user-info">
            <text class="user-name">{{item.userNickname}}</text>
            <text class="request-time">{{item.createdAt}}</text>
          </view>
          <view class="request-status {{item.status}}">{{item.status === 'pending' ? 'å¾…å®¡æ ¸' : item.status === 'approved' ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»'}}</view>
        </view>
        <view class="request-body">
          <view class="request-row">
            <text class="request-label">é‡‘é¢</text>
            <text class="request-amount">Â¥{{tools.formatMoney(item.amount)}}</text>
          </view>
          <view class="request-row" wx:if="{{item.description}}">
            <text class="request-label">å¤‡æ³¨</text>
            <text class="request-desc">{{item.description}}</text>
          </view>
        </view>
        <view class="review-actions" wx:if="{{item.status === 'pending'}}">
          <view class="action-btn approve" bindtap="showReview" data-request="{{item}}">å®¡æ ¸</view>
        </view>
      </view>
      <view class="empty-tip" wx:if="{{requests.length === 0}}">æš‚æ— ç”³è¯·è®°å½•</view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-bottom"></view>
</view>

<!-- å­˜å–æ¬¾å¼¹çª— -->
<view class="modal-overlay {{showActionModal ? 'show' : ''}}" bindtap="closeActionModal">
  <view class="modal-container action-modal glass-card" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">
        {{actionType === 'request' ? 'ğŸ“ ç”³è¯·å­˜æ¬¾' : actionType === 'deposit' ? 'ğŸ’° å­˜æ¬¾' : 'ğŸ’¸ å–æ¬¾'}}
      </text>
      <view class="modal-close" bindtap="closeActionModal">Ã—</view>
    </view>
    
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">é‡‘é¢</text>
        <view class="amount-input-wrap">
          <text class="currency-prefix">Â¥</text>
          <input 
            class="amount-input" 
            type="digit" 
            placeholder="è¯·è¾“å…¥é‡‘é¢"
            value="{{actionAmount}}"
            focus="{{showActionModal}}"
            bindinput="onAmountInput"
          />
        </view>
      </view>
      
      <view class="input-group">
        <text class="input-label">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</text>
        <view class="text-input-wrapper">
          <input 
            class="text-input" 
            placeholder="å¦‚ï¼šå‹å²é’±ã€é›¶èŠ±é’±ç­‰"
            value="{{actionDescription}}"
            bindinput="onDescriptionInput"
          />
        </view>
      </view>

      <view class="current-balance-tip" wx:if="{{actionType === 'withdraw'}}">
        <text>å½“å‰å¯å–ï¼šÂ¥{{tools.formatMoney(account.balance)}}</text>
      </view>
    </view>
    
    <view class="modal-footer">
      <view class="cancel-btn" bindtap="closeActionModal">å–æ¶ˆ</view>
      <view class="confirm-btn btn-active-feedback {{isSubmitting ? 'disabled' : ''}}" bindtap="confirmAction">
        {{isSubmitting ? 'å¤„ç†ä¸­...' : 'ç¡®è®¤'}}
      </view>
    </view>
  </view>
</view>

<!-- å®¡æ ¸å¼¹çª— -->
<view class="modal-overlay {{showReviewModal ? 'show' : ''}}" bindtap="closeReviewModal">
  <view class="modal-container review-modal glass-card" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">ğŸ” å®¡æ ¸ç”³è¯·</text>
      <view class="modal-close" bindtap="closeReviewModal">Ã—</view>
    </view>
    
    <view class="modal-body" wx:if="{{currentRequest}}">
      <view class="review-info-box">
        <view class="review-row">
          <text class="review-label">ç”³è¯·äºº</text>
          <text class="review-value">{{currentRequest.userNickname}}</text>
        </view>
        <view class="review-row">
          <text class="review-label">é‡‘é¢</text>
          <text class="review-value highlight">Â¥{{tools.formatMoney(currentRequest.amount)}}</text>
        </view>
      </view>

      <view class="input-group">
        <text class="input-label">æ‹’ç»åŸå› ï¼ˆä»…åœ¨æ‹’ç»æ—¶å¡«å†™ï¼‰</text>
        <view class="text-input-wrapper">
          <input 
            class="text-input" 
            placeholder="å¡«å†™æ‹’ç»åŸå› "
            value="{{rejectReason}}"
            bindinput="onRejectReasonInput"
          />
        </view>
      </view>
    </view>
    
    <view class="modal-footer">
      <view class="reject-btn" bindtap="rejectRequest">æ‹’ç»</view>
      <view class="approve-btn btn-active-feedback" bindtap="approveRequest">æ‰¹å‡†</view>
    </view>
  </view>
</view>

<!-- åˆ©ç‡è®¾ç½®å¼¹çª— -->
<view class="modal-overlay {{showRateModal ? 'show' : ''}}" bindtap="closeRateModal">
  <view class="modal-container rate-modal glass-card" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">âš™ï¸ è®¾ç½®å¹´åˆ©ç‡</text>
      <view class="modal-close" bindtap="closeRateModal">Ã—</view>
    </view>
    
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">å¹´åˆ©ç‡ï¼ˆ%ï¼‰</text>
        <view class="amount-input-wrap">
          <input 
            class="amount-input" 
            type="digit" 
            placeholder="å¦‚ï¼š3.00"
            value="{{newRate}}"
            bindinput="onRateInput"
          />
          <text class="unit-suffix">%</text>
        </view>
      </view>
      
      <view class="rate-presets">
        <view class="preset-tag" data-rate="1" bindtap="onRateInput">1%</view>
        <view class="preset-tag" data-rate="3" bindtap="onRateInput">3%</view>
        <view class="preset-tag" data-rate="5" bindtap="onRateInput">5%</view>
        <view class="preset-tag" data-rate="10" bindtap="onRateInput">10%</view>
      </view>
    </view>
    
    <view class="modal-footer">
      <view class="cancel-btn" bindtap="closeRateModal">å–æ¶ˆ</view>
      <view class="confirm-btn btn-active-feedback" bindtap="confirmRate">ä¿å­˜</view>
    </view>
  </view>
</view>

<!-- æˆå‘˜ç®¡ç†å¼¹çª— -->
<view class="modal-overlay {{showMemberModal ? 'show' : ''}}" bindtap="closeMemberModal">
  <view class="modal-container member-modal glass-card" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">ğŸ‘¥ ç®¡ç†å‘˜è®¾ç½®</text>
      <view class="modal-close" bindtap="closeMemberModal">Ã—</view>
    </view>
    
    <view class="modal-body">
      <scroll-view scroll-y class="member-list-scroll">
        <view class="member-item-row" wx:for="{{familyMembers}}" wx:key="id">
          <image class="mini-avatar" src="{{item.avatarUrl || '/assets/images/default-avatar.png'}}" mode="aspectFill" />
          <view class="member-name-col">
            <text class="name">{{item.nickname}}</text>
            <text class="role {{item.role}}">{{item.role === 'creator' ? 'åˆ›å»ºäºº' : item.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æˆå‘˜'}}</text>
          </view>
          <switch wx:if="{{item.role !== 'creator'}}" checked="{{item.role === 'admin'}}" color="#000" data-member="{{item}}" bindchange="toggleSubAdmin" />
        </view>
      </scroll-view>
    </view>
  </view>
</view>
