<!--pages/savings/savings.wxml-->
<wxs src="./savings.wxs" module="tools" />
<view class="container">
  <!-- å¤´éƒ¨èƒŒæ™¯ -->
  <view class="header-bg">
    <view class="header-content">
      <view class="header-top">
        <view class="back-btn" bindtap="goBack">
          <text class="back-icon">â†</text>
        </view>
        <text class="page-title">ğŸ’° æˆ‘çš„å­˜æ¬¾</text>
        <view class="header-right">
          <view wx:if="{{isCreator}}" bindtap="showMemberManage" class="header-btn">
            <text>ğŸ‘¥</text>
          </view>
          <view wx:if="{{isCreator}}" bindtap="showRateSetting" class="header-btn">
            <text>âš™ï¸</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view class="main-content" wx:if="{{!isLoading && account}}">
    <!-- Tab åˆ‡æ¢ï¼ˆç®¡ç†å‘˜å¯è§ï¼‰ -->
    <view class="tabs" wx:if="{{isAdmin}}">
      <view class="tab-item {{activeTab === 'overview' ? 'active' : ''}}" 
            data-tab="overview" bindtap="switchTab">
        <text>è´¦æˆ·æ¦‚è§ˆ</text>
      </view>
      <view class="tab-item {{activeTab === 'requests' ? 'active' : ''}}" 
            data-tab="requests" bindtap="switchTab">
        <text>å®¡æ ¸ç”³è¯·</text>
        <view class="badge" wx:if="{{pendingCount > 0}}">{{pendingCount}}</view>
      </view>
    </view>

    <!-- è´¦æˆ·æ¦‚è§ˆ -->
    <view wx:if="{{activeTab === 'overview'}}">
      <!-- å­˜æ¬¾å¡ç‰‡ -->
      <view class="savings-card">
        <view class="balance-section">
          <text class="balance-label">è´¦æˆ·ä½™é¢</text>
          <view class="balance-amount">
            <text class="currency">Â¥</text>
            <text class="amount">{{tools.formatMoney(account.balance)}}</text>
          </view>
        </view>

        <view class="card-divider">
          <view class="divider-line"></view>
          <view class="divider-icon">ğŸ’</view>
          <view class="divider-line"></view>
        </view>

        <view class="interest-section">
          <view class="interest-item">
            <text class="interest-label">å¹´åˆ©ç‡</text>
            <text class="interest-value rate">{{tools.formatPercent(account.annualRate)}}%</text>
          </view>
          <view class="interest-item">
            <text class="interest-label">ç´¯è®¡åˆ©æ¯</text>
            <text class="interest-value">Â¥{{tools.formatMoney(account.totalInterest)}}</text>
          </view>
        </view>
      </view>

      <!-- å¾…å‘åˆ©æ¯å¡ç‰‡ -->
      <view class="pending-interest-card" wx:if="{{account.pendingInterest > 0}}">
        <view class="pending-header">
          <text class="pending-title">ğŸŒ± å¾…ç»“ç®—åˆ©æ¯</text>
          <text class="pending-days">{{account.pendingDays}}å¤©</text>
        </view>
        
        <view class="pending-amount-row">
          <view class="pending-amount {{interestAnimating ? 'animating' : ''}}">
            <text class="currency-small">+Â¥</text>
            <text class="amount-value">{{displayedInterest}}</text>
          </view>
          <button class="settle-btn" bindtap="settleInterest">ç»“ç®—</button>
        </view>
        
        <view class="pending-tip">
          <text>ğŸ’¡ å¤åˆ©é­”æ³•ï¼šä½ çš„é’±æ­£åœ¨ä¸ºä½ å·¥ä½œï¼</text>
        </view>
      </view>

      <!-- å¤åˆ©ç§‘æ™®å¡ç‰‡ -->
      <view class="edu-card">
        <view class="edu-header">
          <text class="edu-icon">ğŸ“š</text>
          <text class="edu-title">ä»€ä¹ˆæ˜¯å¤åˆ©ï¼Ÿ</text>
        </view>
        <view class="edu-content">
          <text class="edu-text">å¤åˆ©æ˜¯"åˆ©æ»šåˆ©"â€”â€”ä»Šå¤©çš„åˆ©æ¯ä¼šåœ¨æ˜å¤©ç»§ç»­äº§ç”Ÿåˆ©æ¯ã€‚çˆ±å› æ–¯å¦ç§°å®ƒä¸º"ä¸–ç•Œç¬¬å…«å¤§å¥‡è¿¹"ï¼</text>
          <view class="edu-example">
            <text>å‡è®¾å­˜100å…ƒï¼Œå¹´åˆ©ç‡3%ï¼š</text>
            <text>â€¢ 1å¹´åï¼š103.05å…ƒ</text>
            <text>â€¢ 10å¹´åï¼š134.83å…ƒ</text>
            <text>â€¢ 20å¹´åï¼š181.67å…ƒ</text>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <!-- æ™®é€šç”¨æˆ·ï¼šç”³è¯·å­˜æ¬¾ -->
        <button class="action-btn request" bindtap="showDepositRequest" wx:if="{{!isAdmin}}">
          <text class="btn-icon">ğŸ“</text>
          <text class="btn-text">ç”³è¯·å­˜æ¬¾</text>
        </button>
        
        <!-- ç®¡ç†å‘˜ï¼šç›´æ¥å­˜æ¬¾/å–æ¬¾ -->
        <block wx:if="{{isAdmin}}">
          <button class="action-btn deposit" bindtap="showDeposit">
            <text class="btn-icon">ğŸ“¥</text>
            <text class="btn-text">å­˜æ¬¾</text>
          </button>
          <button class="action-btn withdraw" bindtap="showWithdraw">
            <text class="btn-icon">ğŸ“¤</text>
            <text class="btn-text">å–æ¬¾</text>
          </button>
        </block>
      </view>

      <!-- äº¤æ˜“è®°å½• -->
      <view class="transactions-section">
        <view class="section-header">
          <text class="section-title">ğŸ“‹ äº¤æ˜“è®°å½•</text>
        </view>
        
        <view class="transactions-list" wx:if="{{transactions.length > 0}}">
          <view class="transaction-item" wx:for="{{transactions}}" wx:key="id">
            <view class="transaction-left">
              <view class="transaction-icon {{item.type}}">
                <text wx:if="{{item.type === 'deposit'}}">ğŸ“¥</text>
                <text wx:elif="{{item.type === 'withdraw'}}">ğŸ“¤</text>
                <text wx:else>âœ¨</text>
              </view>
              <view class="transaction-info">
                <text class="transaction-desc">{{item.description || (item.type === 'deposit' ? 'å­˜æ¬¾' : item.type === 'withdraw' ? 'å–æ¬¾' : 'åˆ©æ¯')}}</text>
                <text class="transaction-time">{{item.createdAt}}</text>
              </view>
            </view>
            <view class="transaction-right">
              <text class="transaction-amount {{item.type === 'withdraw' ? 'negative' : 'positive'}}">
                {{item.type === 'withdraw' ? '-' : '+'}}Â¥{{tools.formatMoney(item.amount)}}
              </text>
              <text class="transaction-balance">ä½™é¢: Â¥{{tools.formatMoney(item.balanceAfter)}}</text>
            </view>
          </view>
        </view>
        
        <view class="empty-transactions" wx:else>
          <text class="empty-icon">ğŸ“­</text>
          <text class="empty-text">æš‚æ— äº¤æ˜“è®°å½•</text>
          <text class="empty-tip">å¼€å§‹å­˜æ¬¾ï¼Œè®©é’±ä¸ºä½ å·¥ä½œå§ï¼</text>
        </view>
      </view>
    </view>

    <!-- å®¡æ ¸ç”³è¯·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰ -->
    <view wx:if="{{activeTab === 'requests' && isAdmin}}" class="requests-section">
      <view class="requests-list" wx:if="{{requests.length > 0}}">
        <view class="request-item {{item.status}}" wx:for="{{requests}}" wx:key="id">
          <view class="request-header">
            <view class="request-user">
              <image class="user-avatar" src="{{item.userAvatar || '/assets/images/default-avatar.png'}}" mode="aspectFill"></image>
              <text class="user-name">{{item.userNickname}}</text>
            </view>
            <view class="request-status {{item.status}}">
              <text wx:if="{{item.status === 'pending'}}">â³ å¾…å®¡æ ¸</text>
              <text wx:elif="{{item.status === 'approved'}}">âœ… å·²é€šè¿‡</text>
              <text wx:else>âŒ å·²æ‹’ç»</text>
            </view>
          </view>
          
          <view class="request-body">
            <view class="request-amount">
              <text class="amount-label">ç”³è¯·é‡‘é¢</text>
              <text class="amount-value">Â¥{{tools.formatMoney(item.amount)}}</text>
            </view>
            <view class="request-desc" wx:if="{{item.description}}">
              <text>å¤‡æ³¨ï¼š{{item.description}}</text>
            </view>
            <view class="request-time">
              <text>{{item.createdAt}}</text>
            </view>
          </view>
          
          <view class="request-footer" wx:if="{{item.status === 'pending'}}">
            <button class="review-btn" data-request="{{item}}" bindtap="showReview">
              å®¡æ ¸
            </button>
          </view>
          
          <view class="request-result" wx:if="{{item.status !== 'pending'}}">
            <text wx:if="{{item.reviewerName}}">å®¡æ ¸äººï¼š{{item.reviewerName}}</text>
            <text wx:if="{{item.rejectReason}}">åŸå› ï¼š{{item.rejectReason}}</text>
          </view>
        </view>
      </view>
      
      <view class="empty-requests" wx:else>
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-text">æš‚æ— ç”³è¯·è®°å½•</text>
      </view>
    </view>
  </view>

  <!-- å­˜å–æ¬¾å¼¹çª— -->
  <view class="modal-overlay {{showActionModal ? 'show' : ''}}" bindtap="closeActionModal">
    <view class="modal-container action-modal" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">
          {{actionType === 'request' ? 'ğŸ“ ç”³è¯·å­˜æ¬¾' : actionType === 'deposit' ? 'ğŸ’° å­˜æ¬¾' : 'ğŸ’¸ å–æ¬¾'}}
        </text>
        <view class="modal-close" bindtap="closeActionModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="input-group">
          <text class="input-label">é‡‘é¢</text>
          <view class="amount-input-wrap">
            <text class="currency-prefix">Â¥</text>
            <input 
              class="amount-input" 
              type="digit" 
              placeholder="è¯·è¾“å…¥é‡‘é¢"
              value="{{actionAmount}}"
              bindinput="onAmountInput"
            />
          </view>
        </view>
        
        <view class="input-group">
          <text class="input-label">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</text>
          <input 
            class="text-input" 
            placeholder="å¦‚ï¼šå‹å²é’±ã€é›¶èŠ±é’±ç­‰"
            value="{{actionDescription}}"
            bindinput="onDescriptionInput"
          />
        </view>

        <view class="current-balance" wx:if="{{actionType === 'withdraw'}}">
          <text>å½“å‰å¯å–ï¼šÂ¥{{tools.formatMoney(account.balance)}}</text>
        </view>

        <view class="request-tip" wx:if="{{actionType === 'request'}}">
          <text class="tip-icon">ğŸ’¡</text>
          <text class="tip-text">æäº¤ç”³è¯·åï¼Œè¯·å°†é’±è½¬ç»™ç®¡ç†å‘˜ã€‚ç®¡ç†å‘˜ç¡®è®¤æ”¶åˆ°åä¼šæ‰¹å‡†æ‚¨çš„å­˜æ¬¾ã€‚</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeActionModal">å–æ¶ˆ</button>
        <button 
          class="confirm-btn {{actionType}}" 
          bindtap="confirmAction"
          disabled="{{isSubmitting}}"
        >
          {{isSubmitting ? 'å¤„ç†ä¸­...' : actionType === 'request' ? 'æäº¤ç”³è¯·' : 'ç¡®è®¤'}}
        </button>
      </view>
    </view>
  </view>

  <!-- å®¡æ ¸å¼¹çª— -->
  <view class="modal-overlay {{showReviewModal ? 'show' : ''}}" bindtap="closeReviewModal">
    <view class="modal-container review-modal" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">ğŸ” å®¡æ ¸å­˜æ¬¾ç”³è¯·</text>
        <view class="modal-close" bindtap="closeReviewModal">Ã—</view>
      </view>
      
      <view class="modal-body" wx:if="{{currentRequest}}">
        <view class="review-info">
          <view class="review-row">
            <text class="review-label">ç”³è¯·äºº</text>
            <text class="review-value">{{currentRequest.userNickname}}</text>
          </view>
          <view class="review-row">
            <text class="review-label">ç”³è¯·é‡‘é¢</text>
            <text class="review-value highlight">Â¥{{tools.formatMoney(currentRequest.amount)}}</text>
          </view>
          <view class="review-row" wx:if="{{currentRequest.description}}">
            <text class="review-label">å¤‡æ³¨</text>
            <text class="review-value">{{currentRequest.description}}</text>
          </view>
        </view>

        <view class="review-warning">
          <text class="warning-icon">âš ï¸</text>
          <text class="warning-text">è¯·ç¡®è®¤å·²æ”¶åˆ°å¯¹åº”é‡‘é¢çš„è½¬è´¦åå†æ‰¹å‡†</text>
        </view>

        <view class="input-group">
          <text class="input-label">æ‹’ç»åŸå› ï¼ˆæ‹’ç»æ—¶å¿…å¡«ï¼‰</text>
          <input 
            class="text-input" 
            placeholder="å¦‚ï¼šæœªæ”¶åˆ°è½¬è´¦"
            value="{{rejectReason}}"
            bindinput="onRejectReasonInput"
          />
        </view>
      </view>
      
      <view class="modal-footer review-footer">
        <button class="reject-btn" bindtap="rejectRequest">æ‹’ç»</button>
        <button class="approve-btn" bindtap="approveRequest">æ‰¹å‡†</button>
      </view>
    </view>
  </view>

  <!-- åˆ©ç‡è®¾ç½®å¼¹çª— -->
  <view class="modal-overlay {{showRateModal ? 'show' : ''}}" bindtap="closeRateModal">
    <view class="modal-container rate-modal" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">âš™ï¸ è®¾ç½®å¹´åˆ©ç‡</text>
        <view class="modal-close" bindtap="closeRateModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="input-group">
          <text class="input-label">å¹´åˆ©ç‡ï¼ˆ%ï¼‰</text>
          <view class="rate-input-wrap">
            <input 
              class="rate-input" 
              type="digit" 
              placeholder="å¦‚ï¼š3.00"
              value="{{newRate}}"
              bindinput="onRateInput"
            />
            <text class="rate-suffix">%</text>
          </view>
        </view>
        
        <view class="rate-presets">
          <text class="preset-label">å¿«æ·é€‰æ‹©ï¼š</text>
          <view class="preset-btns">
            <button class="preset-btn" data-rate="1" bindtap="onRateInput">1%</button>
            <button class="preset-btn" data-rate="3" bindtap="onRateInput">3%</button>
            <button class="preset-btn" data-rate="5" bindtap="onRateInput">5%</button>
            <button class="preset-btn" data-rate="10" bindtap="onRateInput">10%</button>
          </view>
        </view>
        
        <view class="rate-tip">
          <text>ğŸ’¡ é“¶è¡Œæ´»æœŸåˆ©ç‡çº¦0.3%ï¼Œå®šæœŸçº¦2-3%</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeRateModal">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="confirmRate">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- æˆå‘˜ç®¡ç†å¼¹çª— -->
  <view class="modal-overlay {{showMemberModal ? 'show' : ''}}" bindtap="closeMemberModal">
    <view class="modal-container member-modal" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">ğŸ‘¥ ç®¡ç†å‘˜è®¾ç½®</text>
        <view class="modal-close" bindtap="closeMemberModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="member-tip">
          <text>ğŸ’¡ å­ç®¡ç†å‘˜å¯ä»¥å®¡æ ¸å­˜æ¬¾ç”³è¯·ã€ç›´æ¥å­˜å–æ¬¾</text>
        </view>
        
        <view class="members-list">
          <view class="member-item" wx:for="{{familyMembers}}" wx:key="id">
            <view class="member-info">
              <image class="member-avatar" src="{{item.avatar_url || item.avatarUrl || '/assets/images/default-avatar.png'}}" mode="aspectFill"></image>
              <view class="member-detail">
                <text class="member-name">{{item.nickname}}</text>
                <text class="member-role {{item.role}}">
                  {{item.role === 'creator' ? 'ğŸ‘‘ åˆ›å»ºäºº' : item.role === 'admin' ? 'â­ å­ç®¡ç†å‘˜' : 'ğŸ‘¤ æˆå‘˜'}}
                </text>
              </view>
            </view>
            <view class="member-action" wx:if="{{item.role !== 'creator'}}">
              <switch 
                checked="{{item.role === 'admin'}}" 
                data-member="{{item}}"
                bindchange="toggleSubAdmin"
                color="#667eea"
              />
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
